
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Explainer-notebook.ipynb &#8212; How the Media Talks About People</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'explainer';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Language Analysis" href="analysis.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo3.png" class="logo__image only-light" alt="How the Media Talks About People - Home"/>
    <script>document.write(`<img src="_static/logo3.png" class="logo__image only-dark" alt="How the Media Talks About People - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="dataset.html">Dataset</a></li>


<li class="toctree-l1"><a class="reference internal" href="data-processing.html">Data Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="network.html">Network Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="analysis.html">Language Analysis</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Explainer-notebook.ipynb</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fexplainer.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/explainer.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Explainer-notebook.ipynb</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-and-motivation">💡 Introduction and Motivation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset">🗂️ Dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pre-processing-and-overview">📶 Pre-Processing and Overview</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#subset-entertainment">Subset Entertainment</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#natural-language-processing-nlp">🌐 Natural Language Processing (NLP)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#named-entity-recognition-ner">Named Entity Recognition (NER)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dependency-parsing">Dependency Parsing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#coreference-resolution">Coreference Resolution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sentiment-analysis">Sentiment Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nlp-dataset">NLP Dataset</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#person-name-processing">🪪 Person Name Processing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#alias-assignment">Alias Assignment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#genderization">Genderization</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#network">👨‍👩‍👧‍👦 Network</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creation-of-co-mention-network">Creation of co-mention network</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-of-co-mention-graph">Analysis of co-mention graph</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#powerlaw-and-top-hubs">Powerlaw and top-hubs:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#random-network-or-tendency">Random network or tendency?:</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#community-detection">Community detection</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#language-analysis-using-nlp-and-tf-idf">🔎 Language Analysis (Using NLP and TF-IDF)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#community-analysis">Community Analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#gendered-wording-analysis-using-tf-idf">Gendered wording analysis using TF-IDF</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sentiment-analysis-of-communtiies">Sentiment analysis of communtiies</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hatespeech-analysis-of-communtiies">Hatespeech analysis of communtiies</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#emotion-distribution-of-communtiies">Emotion distribution of communtiies</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-sampled-analysis"><strong>Random-sampled analysis</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#general-td-idf">General TD-IDF</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#p-test-of-offensive-langauge">P-test of offensive langauge</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#p-test-of-sentiment">P-test of sentiment</a></li>
</ul>
</li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="explainer-notebook-ipynb">
<h1>Explainer-notebook.ipynb<a class="headerlink" href="#explainer-notebook-ipynb" title="Link to this heading">#</a></h1>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Task contribution</p></th>
<th class="head"><p>Jonas (%)</p></th>
<th class="head"><p>Alexander (%)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Dataset</p></td>
<td><p>60</p></td>
<td><p>40</p></td>
</tr>
<tr class="row-odd"><td><p>NLP</p></td>
<td><p>40</p></td>
<td><p>60</p></td>
</tr>
<tr class="row-even"><td><p>Preprocessing</p></td>
<td><p>60</p></td>
<td><p>40</p></td>
</tr>
<tr class="row-odd"><td><p>Network</p></td>
<td><p>40</p></td>
<td><p>60</p></td>
</tr>
<tr class="row-even"><td><p>Analysis community</p></td>
<td><p>60</p></td>
<td><p>40</p></td>
</tr>
<tr class="row-odd"><td><p>Analysis global</p></td>
<td><p>40</p></td>
<td><p>60</p></td>
</tr>
</tbody>
</table>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Modules</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.image</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpimg</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">spacy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">spacy</span><span class="w"> </span><span class="kn">import</span> <span class="n">displacy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dacy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">netwulf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>

<span class="c1"># Imports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nlp_utils</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">powerlaw</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">network_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">louvain_based_communities_randomized</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="kn">import</span> <span class="n">edge_boundary</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">difflib</span><span class="w"> </span><span class="kn">import</span> <span class="n">SequenceMatcher</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.feature_extraction.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">TfidfVectorizer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wordcloud</span><span class="w"> </span><span class="kn">import</span> <span class="n">WordCloud</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="c1"># Configuration</span>
<span class="n">spacy</span><span class="o">.</span><span class="n">require_gpu</span><span class="p">()</span> <span class="c1"># run SpaCy GPU-accelerated</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">()</span>

<span class="c1"># Ignore warnings for prettier output</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/vscode/.local/lib/python3.10/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">16</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="c1"># Imports</span>
<span class="ne">---&gt; </span><span class="mi">16</span> <span class="kn">from</span><span class="w"> </span><span class="nn">nlp_utils</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> <span class="kn">import</span><span class="w"> </span><span class="nn">powerlaw</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;nlp_utils&#39;
</pre></div>
</div>
</div>
</div>
<section id="introduction-and-motivation">
<h2>💡 Introduction and Motivation<a class="headerlink" href="#introduction-and-motivation" title="Link to this heading">#</a></h2>
<p>Being a celebrity also means being a public person. which means being constantly in the limelight, and much of what they do is documented and shared by the media. It is still known today that theres a gender differnence in news articles. In this project we will highlight gender specific language in news articles.</p>
</section>
<section id="dataset">
<h2>🗂️ Dataset<a class="headerlink" href="#dataset" title="Link to this heading">#</a></h2>
<p>While we wanted to do much of the data collection ourselves, we faced numerous challenges. First, newspaper articles are intellectual properties owned by the author and/or the newspaper outlet, and so naturally we do not want to face any legal challenges by using them in our research without their consent. Secondly, during a pilot study we ran into rate limiting issues while scraping articles using various search engines, not to mention the bias that search engines would pose on the articles we’d actually collect from them.</p>
<p>To direct our focus on datasets that weren’t infeasible wrt. size, we decided to look at Danish national newspapers. We came across <a class="reference external" href="https://recsys.eb.dk/">EB-NeRD</a>, which is a dataset comprising of 125,000+ articles spanning from 1993-2023.</p>
<blockquote>
<div><p>NOTE: Due to the license of EB-NERD we may not share the dataset, you will have to download yourself and accept their terms and conditions.</p>
</div></blockquote>
<blockquote>
<div><p>License disclaimer: The use of EB-nerd is purely educational in this project by applying social science methods on it, we are not using it to derive any product such as LLM training.</p>
</div></blockquote>
<p>Below is a snippet of the dataset imported as a <code class="docutils literal notranslate"><span class="pre">pandas</span></code> DataFrame, showing only the relevant columns:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load dataset</span>
<span class="n">df_articles</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;dataset/articles.parquet&quot;</span><span class="p">)</span>

<span class="c1"># Remove empty articles</span>
<span class="n">df_articles</span> <span class="o">=</span> <span class="n">df_articles</span><span class="p">[</span><span class="n">df_articles</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Columns</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_articles</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>article_id
title
subtitle
last_modified_time
premium
body
published_time
image_ids
article_type
url
ner_clusters
entity_groups
topics
category
subcategory
category_str
total_inviews
total_pageviews
total_read_time
sentiment_score
sentiment_label
</pre></div>
</div>
</div>
</div>
</section>
<section id="pre-processing-and-overview">
<h2>📶 Pre-Processing and Overview<a class="headerlink" href="#pre-processing-and-overview" title="Link to this heading">#</a></h2>
<p>We firstly take can look at the proportion of articles from each category to see what they prefer to write about:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Count categories</span>
<span class="n">category_counts</span> <span class="o">=</span> <span class="n">df_articles</span><span class="p">[</span><span class="s1">&#39;category_str&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>

<span class="c1"># Top 5 categories</span>
<span class="n">top_categories</span> <span class="o">=</span> <span class="n">category_counts</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>

<span class="c1"># Replace all other categories with &#39;Other&#39;</span>
<span class="n">df_articles</span><span class="p">[</span><span class="s1">&#39;category_grouped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_articles</span><span class="p">[</span><span class="s1">&#39;category_str&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_articles</span><span class="p">[</span><span class="s1">&#39;category_str&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">top_categories</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s1">&#39;Other&#39;</span><span class="p">)</span>

<span class="c1"># Re-count including &#39;Other&#39;</span>
<span class="n">grouped_counts</span> <span class="o">=</span> <span class="n">df_articles</span><span class="p">[</span><span class="s1">&#39;category_grouped&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>

<span class="c1"># Plot pie chart</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">grouped_counts</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">startangle</span><span class="o">=</span><span class="mi">140</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Top 7 Categories + Other&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;website/figures/category-pie-chart.svg&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/da184b04e7b4d49752258c28af0d83d820baa7590f6ecfc5310c5416470bc330.png" src="_images/da184b04e7b4d49752258c28af0d83d820baa7590f6ecfc5310c5416470bc330.png" />
</div>
</div>
<p>and a <span class="math notranslate nohighlight">\(\log\)</span>-normalized timeline of the number of articles per month, for each category:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ensure &#39;published_time&#39; is datetime</span>
<span class="n">df_articles</span><span class="p">[</span><span class="s1">&#39;published_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_articles</span><span class="p">[</span><span class="s1">&#39;published_time&#39;</span><span class="p">])</span>

<span class="c1"># Create &#39;year_month&#39; column for grouping</span>
<span class="n">df_articles</span><span class="p">[</span><span class="s1">&#39;year_month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_articles</span><span class="p">[</span><span class="s1">&#39;published_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="c1"># Use the previously grouped categories (top 5 + &#39;Other&#39;)</span>
<span class="n">category_counts</span> <span class="o">=</span> <span class="n">df_articles</span><span class="p">[</span><span class="s1">&#39;category_str&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">top5_categories</span> <span class="o">=</span> <span class="n">category_counts</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
<span class="n">df_articles</span><span class="p">[</span><span class="s1">&#39;category_grouped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_articles</span><span class="p">[</span><span class="s1">&#39;category_str&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_articles</span><span class="p">[</span><span class="s1">&#39;category_str&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">top5_categories</span><span class="p">),</span> <span class="s1">&#39;Other&#39;</span><span class="p">)</span>

<span class="c1"># Group by year_month and grouped category</span>
<span class="n">monthly_counts_grouped</span> <span class="o">=</span> <span class="n">df_articles</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year_month&#39;</span><span class="p">,</span> <span class="s1">&#39;category_grouped&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>

<span class="c1"># Convert year_month back to datetime for plotting</span>
<span class="n">monthly_counts_grouped</span><span class="p">[</span><span class="s1">&#39;year_month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">monthly_counts_grouped</span><span class="p">[</span><span class="s1">&#39;year_month&#39;</span><span class="p">])</span>

<span class="c1"># Plot the timeline</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">monthly_counts_grouped</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;year_month&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;category_grouped&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>  <span class="c1"># Apply log scale</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Monthly Article Count (Log Scale) - Top 5 Categories + Other&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Log(Number of Articles)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;website/figures/monthly-article-count.svg&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2f012e0b5c92cb43b88be5f3968fec920499582cb44520155a0fb7e9222eed61.png" src="_images/2f012e0b5c92cb43b88be5f3968fec920499582cb44520155a0fb7e9222eed61.png" />
</div>
</div>
<section id="subset-entertainment">
<h3>Subset Entertainment<a class="headerlink" href="#subset-entertainment" title="Link to this heading">#</a></h3>
<p>From here on out we will only consider a subset of the DataFrame and limit ourselves to the <code class="docutils literal notranslate"><span class="pre">underholdning</span></code> (english: entertainment) category, which comprises over 20% of the dataset as shown above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Entertainment-only DataFrame</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df_articles</span><span class="p">[</span><span class="n">df_articles</span><span class="p">[</span><span class="s2">&quot;category_str&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;underholdning&quot;</span><span class="p">]</span>

<span class="c1"># Number of articles</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>24191
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="natural-language-processing-nlp">
<h2>🌐 Natural Language Processing (NLP)<a class="headerlink" href="#natural-language-processing-nlp" title="Link to this heading">#</a></h2>
<p>A news article dataset without any noteworthy features/attributes is essentially useless, so we needed a way to generate features, so that we can perform proper quantitative analysis.</p>
<p>To achieve this in machine learning fashion, we used NLP in the form of <a class="reference external" href="https://spacy.io/"><code class="docutils literal notranslate"><span class="pre">SpaCy</span></code></a>, specifically the Danish module <a class="reference external" href="https://centre-for-humanities-computing.github.io/DaCy/"><code class="docutils literal notranslate"><span class="pre">DaCy</span></code></a>, since it enables Danish language processing pipelines and is currently the <a class="reference external" href="https://centre-for-humanities-computing.github.io/DaCy/performance.general.html">best performing</a> model on all relevant tasks. We employ the large transformer model and leverage GPU acceleration for optimal speed and accuracy.</p>
<p>We were mainly interested in the following features:</p>
<ul class="simple">
<li><p><strong>Named Entity Recognition (NER):</strong> To find entities, in this case persons and their associated names, in the articles.</p></li>
<li><p><strong>Parts-of-speech tagging (POS):</strong> To find descriptive words (mainly nouns and adjectives) for the detected entities.</p></li>
<li><p><strong>Dependency Parsing:</strong> To link NER to POS and properly assign the right words to the right entities, on a per-sentence basis.</p></li>
<li><p><strong>Lemmatization:</strong> To reduce names and words to their base form (e.g. “kan” becomes “kunne” and “Mikkelsen’s” becomes “Mikkelsen”).</p></li>
<li><p><strong>Coreference Resolution:</strong> To find expressions, mainly pronouns, that refer to the same entity in a text.</p></li>
<li><p><strong>Sentiment Analysis:</strong> In the form of polarity to determine if an article is deemed <code class="docutils literal notranslate"><span class="pre">positive</span></code>, <code class="docutils literal notranslate"><span class="pre">neutral</span></code> or <code class="docutils literal notranslate"><span class="pre">negative</span></code>.</p></li>
<li><p><strong>Emotion Detection:</strong> To classify the kind of emotion(s) found in an article, given that it is emotionally laden.</p></li>
<li><p><strong>Hate Speech Detection:</strong> To classify whether an article is deemed offensive or not.</p></li>
</ul>
<p>The entire NLP pipeline can be found in <code class="docutils literal notranslate"><span class="pre">nlp.py</span></code>, but to build intuition let’s have a look at most central parts of the pipeline, what they effectively do and what results they enable us to achieve.</p>
<p>Programatically, the pipeline looks like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load large DaCy model and add NLP components to pipeline</span>
<span class="n">nlp</span> <span class="o">=</span> <span class="n">dacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;large&quot;</span><span class="p">)</span>                       <span class="c1"># Loads transformer model (incl. NER, coref, lemmatizer, POS tagger)</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;dacy/polarity&quot;</span><span class="p">)</span>                  <span class="c1"># Add sentiment analysis, polarity</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;dacy/emotionally_laden&quot;</span><span class="p">)</span>         <span class="c1"># Add emotion detection</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;dacy/emotion&quot;</span><span class="p">)</span>                   <span class="c1"># Add emotion classification</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;dacy/hatespeech_detection&quot;</span><span class="p">)</span>      <span class="c1"># Add hate speech detection</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s2">&quot;dacy/hatespeech_classification&quot;</span><span class="p">)</span> <span class="c1"># Add hate speech classification</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;spacy_wrap.pipeline_component_seq_clf.SequenceClassificationTransformer at 0x7fdd41ac0ca0&gt;
</pre></div>
</div>
</div>
</div>
<p>Sample a few articles to parse through the NLP pipeline:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sample using seed = 42</span>
<span class="n">sample_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Get article body texts as list</span>
<span class="n">texts</span> <span class="o">=</span> <span class="n">sample_df</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Extract exemplary sentences from the article texts:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">extract_sentences</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">num_sentences</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">sentences</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;=[.!?])\s+&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="c1"># Split into sentences using regex</span>
    
    <span class="n">sentences</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sentences</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">]</span> <span class="c1"># Filter out empty or very short sentences</span>
    
    <span class="n">sampled</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">sentences</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_sentences</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">)))</span> <span class="c1"># Sample randomly from the sentences</span>
    
    <span class="k">return</span> <span class="n">sampled</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sample one sentence from each article in a list</span>
<span class="n">seed</span> <span class="o">=</span> <span class="mi">19</span>
<span class="n">text_sents</span> <span class="o">=</span> <span class="p">[</span><span class="n">extract_sentences</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pipe article-texts to make a generator object</span>
<span class="n">sents</span> <span class="o">=</span> <span class="n">nlp</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">text_sents</span><span class="p">)</span>
<span class="n">sent1</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text_sents</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">docs</span> <span class="o">=</span> <span class="n">nlp</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="named-entity-recognition-ner">
<h3>Named Entity Recognition (NER)<a class="headerlink" href="#named-entity-recognition-ner" title="Link to this heading">#</a></h3>
<p>Below is an illustration of named entity recognition for the sampled sentences in each of the three sampled articles:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">sents</span><span class="p">:</span>
    <span class="n">displacy</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;ent&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span class="tex2jax_ignore"><div class="entities" style="line-height: 2.5; direction: ltr">--------- SPLIT ELEMENT ---------<br>De to første afsnit af 
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    HBO Max-serien
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">MISC
 <a style="text-decoration: none; color: inherit; font-weight: normal" href="#">NIL</a>
</span>
</mark>
 '
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    The Idol
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">MISC
 <a style="text-decoration: none; color: inherit; font-weight: normal" href="#">NIL</a>
</span>
</mark>
' med 
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    Lily-Rose Depp
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">PER
 <a style="text-decoration: none; color: inherit; font-weight: normal" href="#">NIL</a>
</span>
</mark>
 og 
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    Abel '
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">PER
 <a style="text-decoration: none; color: inherit; font-weight: normal" href="#">NIL</a>
</span>
</mark>
The Weeknd' Tesfaye i hovedrollerne har netop haft premiere på filmfestivalen i 
<mark class="entity" style="background: #ff9561; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    Cannes
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">LOC
 <a style="text-decoration: none; color: inherit; font-weight: normal" href="#">NIL</a>
</span>
</mark>
.</div></span></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>----------
</pre></div>
</div>
<div class="output text_html"><span class="tex2jax_ignore"><div class="entities" style="line-height: 2.5; direction: ltr">
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    Nina Agdal
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">PER
 <a style="text-decoration: none; color: inherit; font-weight: normal" href="#">NIL</a>
</span>
</mark>
 i numse-bar trusse<br>TV: Se frække 
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    Nina Agdal
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">PER
 <a style="text-decoration: none; color: inherit; font-weight: normal" href="#">NIL</a>
</span>
</mark>
 vride sig på lagnerne<br>Hvis den 
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    danske
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">MISC
 <a style="text-decoration: none; color: inherit; font-weight: normal" href="#">Q35</a>
</span>
</mark>
 topmodel 
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    Nina Agdal
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">PER
 <a style="text-decoration: none; color: inherit; font-weight: normal" href="#">NIL</a>
</span>
</mark>
 skulle have planer om at gæste dette års 
<mark class="entity" style="background: #ff9561; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    Roskilde Festival
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">LOC
 <a style="text-decoration: none; color: inherit; font-weight: normal" href="#">NIL</a>
</span>
</mark>
, kunne hun passende smutte forbi campingområdet, når det traditionelle og spektakulære nøgenløb afvikles.</div></span></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>----------
</pre></div>
</div>
<div class="output text_html"><span class="tex2jax_ignore"><div class="entities" style="line-height: 2.5; direction: ltr">Den 
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    amerikanske
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">MISC
 <a style="text-decoration: none; color: inherit; font-weight: normal" href="#">Q30</a>
</span>
</mark>
 youtuber 
<mark class="entity" style="background: #ddd; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    Logan Paul
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">PER
 <a style="text-decoration: none; color: inherit; font-weight: normal" href="#">NIL</a>
</span>
</mark>
, der har over 23 millioner abonnenter på den sociale platform, er i 
<mark class="entity" style="background: #ff9561; padding: 0.45em 0.6em; margin: 0 0.25em; line-height: 1; border-radius: 0.35em;">
    København
    <span style="font-size: 0.8em; font-weight: bold; line-height: 1; border-radius: 0.35em; vertical-align: middle; margin-left: 0.5rem">LOC
 <a style="text-decoration: none; color: inherit; font-weight: normal" href="#">Q1748</a>
</span>
</mark>
.</div></span></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>----------
</pre></div>
</div>
</div>
</div>
<p>Here we observe that <code class="docutils literal notranslate"><span class="pre">Lily-Rose</span> <span class="pre">Depp</span></code>, <code class="docutils literal notranslate"><span class="pre">Abel</span> <span class="pre">'</span></code>, <code class="docutils literal notranslate"><span class="pre">Nina</span> <span class="pre">Agdal</span></code> and <code class="docutils literal notranslate"><span class="pre">Logan</span> <span class="pre">Paul</span></code> are all labelled as persons (<code class="docutils literal notranslate"><span class="pre">PER</span></code>). This is precisely how we extract persons (later used as nodes) from articles (which act as edges).</p>
<p>E.g. in this case, <code class="docutils literal notranslate"><span class="pre">Lily-Rose</span> <span class="pre">Depp</span></code> and <code class="docutils literal notranslate"><span class="pre">Abel</span> <span class="pre">'</span></code> would each share an edge with one another in the first shown article from the sample.</p>
</section>
<section id="dependency-parsing">
<h3>Dependency Parsing<a class="headerlink" href="#dependency-parsing" title="Link to this heading">#</a></h3>
<p>We make use of dependency parsing to extract adjectives (<code class="docutils literal notranslate"><span class="pre">ADJ</span></code>) and noun (<code class="docutils literal notranslate"><span class="pre">NOUN</span></code>) modifiers associated with a person (<code class="docutils literal notranslate"><span class="pre">PER</span></code>) in a sentence. This is best illustrated with an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">sents</span><span class="p">:</span>
    <span class="n">displacy</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;dep&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span class="tex2jax_ignore"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:lang="da" id="36fe1c547e3048e39c6a120b3d19c10d-0" class="displacy" width="5475" height="574.5" direction="ltr" style="max-width: none; height: 574.5px; color: #000000; background: #ffffff; font-family: Arial; direction: ltr">
<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="50">---------</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="50">PUNCT</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="225">SPLIT</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="225">PROPN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="400">ELEMENT ---------</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="400">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="575">
</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="575">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="750">De</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="750">DET</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="925">to</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="925">NUM</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="1100">første</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="1100">ADJ</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="1275">afsnit</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="1275">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="1450">af</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="1450">ADP</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="1625">HBO</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="1625">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="1800">Max-serien '</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="1800">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="1975">The</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="1975">PROPN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="2150">Idol'</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="2150">PROPN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="2325">med</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="2325">ADP</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="2500">Lily-Rose</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="2500">PROPN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="2675">Depp</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="2675">PROPN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="2850">og</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="2850">CCONJ</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="3025">Abel '</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="3025">PROPN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="3200">The</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="3200">PROPN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="3375">Weeknd'</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="3375">PROPN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="3550">Tesfaye</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="3550">PROPN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="3725">i</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="3725">ADP</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="3900">hovedrollerne</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="3900">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="4075">har</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="4075">AUX</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="4250">netop</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="4250">ADV</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="4425">haft</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="4425">VERB</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="4600">premiere</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="4600">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="4775">på</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="4775">ADP</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="4950">filmfestivalen</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="4950">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="5125">i</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="5125">ADP</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="5300">Cannes.</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="5300">PROPN</tspan>
</text>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-0" stroke-width="2px" d="M70,439.5 C70,352.0 205.0,352.0 205.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-0" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">punct</textPath>
    </text>
    <path class="displacy-arrowhead" d="M70,441.5 L62,429.5 78,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-1" stroke-width="2px" d="M245,439.5 C245,352.0 380.0,352.0 380.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-1" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nmod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M380.0,441.5 L388.0,429.5 372.0,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-2" stroke-width="2px" d="M595,439.5 C595,2.0 4425.0,2.0 4425.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-2" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">aux</textPath>
    </text>
    <path class="displacy-arrowhead" d="M595,441.5 L587,429.5 603,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-3" stroke-width="2px" d="M770,439.5 C770,177.0 1265.0,177.0 1265.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-3" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">det</textPath>
    </text>
    <path class="displacy-arrowhead" d="M770,441.5 L762,429.5 778,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-4" stroke-width="2px" d="M945,439.5 C945,264.5 1260.0,264.5 1260.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-4" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nummod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M945,441.5 L937,429.5 953,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-5" stroke-width="2px" d="M1120,439.5 C1120,352.0 1255.0,352.0 1255.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-5" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">amod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M1120,441.5 L1112,429.5 1128,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-6" stroke-width="2px" d="M1295,439.5 C1295,89.5 4420.0,89.5 4420.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-6" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nsubj</textPath>
    </text>
    <path class="displacy-arrowhead" d="M1295,441.5 L1287,429.5 1303,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-7" stroke-width="2px" d="M1470,439.5 C1470,264.5 1785.0,264.5 1785.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-7" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">case</textPath>
    </text>
    <path class="displacy-arrowhead" d="M1470,441.5 L1462,429.5 1478,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-8" stroke-width="2px" d="M1645,439.5 C1645,352.0 1780.0,352.0 1780.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-8" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nmod:poss</textPath>
    </text>
    <path class="displacy-arrowhead" d="M1645,441.5 L1637,429.5 1653,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-9" stroke-width="2px" d="M1295,439.5 C1295,177.0 1790.0,177.0 1790.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-9" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nmod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M1790.0,441.5 L1798.0,429.5 1782.0,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-10" stroke-width="2px" d="M1820,439.5 C1820,352.0 1955.0,352.0 1955.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-10" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">appos</textPath>
    </text>
    <path class="displacy-arrowhead" d="M1955.0,441.5 L1963.0,429.5 1947.0,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-11" stroke-width="2px" d="M1995,439.5 C1995,352.0 2130.0,352.0 2130.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-11" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">flat</textPath>
    </text>
    <path class="displacy-arrowhead" d="M2130.0,441.5 L2138.0,429.5 2122.0,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-12" stroke-width="2px" d="M2345,439.5 C2345,352.0 2480.0,352.0 2480.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-12" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">dep</textPath>
    </text>
    <path class="displacy-arrowhead" d="M2345,441.5 L2337,429.5 2353,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-13" stroke-width="2px" d="M1820,439.5 C1820,264.5 2485.0,264.5 2485.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-13" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nmod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M2485.0,441.5 L2493.0,429.5 2477.0,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-14" stroke-width="2px" d="M2520,439.5 C2520,352.0 2655.0,352.0 2655.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-14" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">flat</textPath>
    </text>
    <path class="displacy-arrowhead" d="M2655.0,441.5 L2663.0,429.5 2647.0,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-15" stroke-width="2px" d="M2870,439.5 C2870,352.0 3005.0,352.0 3005.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-15" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">cc</textPath>
    </text>
    <path class="displacy-arrowhead" d="M2870,441.5 L2862,429.5 2878,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-16" stroke-width="2px" d="M2520,439.5 C2520,264.5 3010.0,264.5 3010.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-16" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">conj</textPath>
    </text>
    <path class="displacy-arrowhead" d="M3010.0,441.5 L3018.0,429.5 3002.0,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-17" stroke-width="2px" d="M3045,439.5 C3045,352.0 3180.0,352.0 3180.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-17" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">flat</textPath>
    </text>
    <path class="displacy-arrowhead" d="M3180.0,441.5 L3188.0,429.5 3172.0,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-18" stroke-width="2px" d="M3220,439.5 C3220,352.0 3355.0,352.0 3355.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-18" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nmod:poss</textPath>
    </text>
    <path class="displacy-arrowhead" d="M3355.0,441.5 L3363.0,429.5 3347.0,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-19" stroke-width="2px" d="M3045,439.5 C3045,264.5 3535.0,264.5 3535.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-19" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">flat</textPath>
    </text>
    <path class="displacy-arrowhead" d="M3535.0,441.5 L3543.0,429.5 3527.0,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-20" stroke-width="2px" d="M3745,439.5 C3745,352.0 3880.0,352.0 3880.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-20" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">case</textPath>
    </text>
    <path class="displacy-arrowhead" d="M3745,441.5 L3737,429.5 3753,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-21" stroke-width="2px" d="M3045,439.5 C3045,177.0 3890.0,177.0 3890.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-21" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nmod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M3890.0,441.5 L3898.0,429.5 3882.0,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-22" stroke-width="2px" d="M4095,439.5 C4095,264.5 4410.0,264.5 4410.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-22" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">aux</textPath>
    </text>
    <path class="displacy-arrowhead" d="M4095,441.5 L4087,429.5 4103,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-23" stroke-width="2px" d="M4270,439.5 C4270,352.0 4405.0,352.0 4405.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-23" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">advmod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M4270,441.5 L4262,429.5 4278,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-24" stroke-width="2px" d="M4445,439.5 C4445,352.0 4580.0,352.0 4580.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-24" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">obj</textPath>
    </text>
    <path class="displacy-arrowhead" d="M4580.0,441.5 L4588.0,429.5 4572.0,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-25" stroke-width="2px" d="M4795,439.5 C4795,352.0 4930.0,352.0 4930.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-25" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">case</textPath>
    </text>
    <path class="displacy-arrowhead" d="M4795,441.5 L4787,429.5 4803,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-26" stroke-width="2px" d="M4620,439.5 C4620,264.5 4935.0,264.5 4935.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-26" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nmod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M4935.0,441.5 L4943.0,429.5 4927.0,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-27" stroke-width="2px" d="M5145,439.5 C5145,352.0 5280.0,352.0 5280.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-27" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">case</textPath>
    </text>
    <path class="displacy-arrowhead" d="M5145,441.5 L5137,429.5 5153,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-36fe1c547e3048e39c6a120b3d19c10d-0-28" stroke-width="2px" d="M4970,439.5 C4970,264.5 5285.0,264.5 5285.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-36fe1c547e3048e39c6a120b3d19c10d-0-28" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nmod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M5285.0,441.5 L5293.0,429.5 5277.0,429.5" fill="currentColor"/>
</g>
</svg></span></div><div class="output text_html"><span class="tex2jax_ignore"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:lang="da" id="168dce14ee3b4b69b37cadd4992f17f2-0" class="displacy" width="7925" height="662.0" direction="ltr" style="max-width: none; height: 662.0px; color: #000000; background: #ffffff; font-family: Arial; direction: ltr">
<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="50">Nina</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="50">PROPN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="225">Agdal</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="225">PROPN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="400">i</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="400">ADP</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="575">numse-bar</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="575">ADJ</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="750">trusse</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="750">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="925">
</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="925">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="1100">TV:</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="1100">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="1275">Se</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="1275">VERB</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="1450">frække</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="1450">ADJ</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="1625">Nina</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="1625">PROPN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="1800">Agdal</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="1800">PROPN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="1975">vride</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="1975">VERB</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="2150">sig</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="2150">PRON</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="2325">på</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="2325">ADP</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="2500">lagnerne</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="2500">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="2675">
</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="2675">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="2850">Hvis</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="2850">SCONJ</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="3025">den</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="3025">DET</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="3200">danske</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="3200">ADJ</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="3375">topmodel</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="3375">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="3550">Nina</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="3550">PROPN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="3725">Agdal</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="3725">PROPN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="3900">skulle</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="3900">AUX</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="4075">have</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="4075">VERB</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="4250">planer</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="4250">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="4425">om</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="4425">ADP</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="4600">at</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="4600">PART</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="4775">gæste</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="4775">VERB</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="4950">dette</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="4950">DET</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="5125">års</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="5125">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="5300">Roskilde</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="5300">PROPN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="5475">Festival,</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="5475">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="5650">kunne</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="5650">AUX</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="5825">hun</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="5825">PRON</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="6000">passende</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="6000">ADV</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="6175">smutte</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="6175">VERB</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="6350">forbi</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="6350">ADP</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="6525">campingområdet,</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="6525">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="6700">når</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="6700">SCONJ</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="6875">det</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="6875">DET</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="7050">traditionelle</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="7050">ADJ</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="7225">og</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="7225">CCONJ</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="7400">spektakulære</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="7400">ADJ</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="7575">nøgenløb</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="7575">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="572.0">
    <tspan class="displacy-word" fill="currentColor" x="7750">afvikles.</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="7750">VERB</tspan>
</text>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-0" stroke-width="2px" d="M70,527.0 C70,177.0 915.0,177.0 915.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-0" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nsubj</textPath>
    </text>
    <path class="displacy-arrowhead" d="M70,529.0 L62,517.0 78,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-1" stroke-width="2px" d="M70,527.0 C70,439.5 200.0,439.5 200.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-1" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">flat</textPath>
    </text>
    <path class="displacy-arrowhead" d="M200.0,529.0 L208.0,517.0 192.0,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-2" stroke-width="2px" d="M420,527.0 C420,352.0 730.0,352.0 730.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-2" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">case</textPath>
    </text>
    <path class="displacy-arrowhead" d="M420,529.0 L412,517.0 428,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-3" stroke-width="2px" d="M595,527.0 C595,439.5 725.0,439.5 725.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-3" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">amod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M595,529.0 L587,517.0 603,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-4" stroke-width="2px" d="M70,527.0 C70,264.5 735.0,264.5 735.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-4" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nmod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M735.0,529.0 L743.0,517.0 727.0,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-5" stroke-width="2px" d="M945,527.0 C945,439.5 1075.0,439.5 1075.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-5" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">amod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M945,529.0 L937,517.0 953,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-6" stroke-width="2px" d="M1120,527.0 C1120,439.5 1250.0,439.5 1250.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-6" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">list</textPath>
    </text>
    <path class="displacy-arrowhead" d="M1250.0,529.0 L1258.0,517.0 1242.0,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-7" stroke-width="2px" d="M1470,527.0 C1470,439.5 1600.0,439.5 1600.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-7" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">amod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M1470,529.0 L1462,517.0 1478,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-8" stroke-width="2px" d="M1295,527.0 C1295,352.0 1605.0,352.0 1605.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-8" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">obj</textPath>
    </text>
    <path class="displacy-arrowhead" d="M1605.0,529.0 L1613.0,517.0 1597.0,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-9" stroke-width="2px" d="M1645,527.0 C1645,439.5 1775.0,439.5 1775.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-9" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">flat</textPath>
    </text>
    <path class="displacy-arrowhead" d="M1775.0,529.0 L1783.0,517.0 1767.0,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-10" stroke-width="2px" d="M1295,527.0 C1295,264.5 1960.0,264.5 1960.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-10" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">xcomp</textPath>
    </text>
    <path class="displacy-arrowhead" d="M1960.0,529.0 L1968.0,517.0 1952.0,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-11" stroke-width="2px" d="M1995,527.0 C1995,439.5 2125.0,439.5 2125.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-11" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">obj</textPath>
    </text>
    <path class="displacy-arrowhead" d="M2125.0,529.0 L2133.0,517.0 2117.0,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-12" stroke-width="2px" d="M2345,527.0 C2345,439.5 2475.0,439.5 2475.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-12" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">case</textPath>
    </text>
    <path class="displacy-arrowhead" d="M2345,529.0 L2337,517.0 2353,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-13" stroke-width="2px" d="M1995,527.0 C1995,352.0 2480.0,352.0 2480.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-13" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">obl</textPath>
    </text>
    <path class="displacy-arrowhead" d="M2480.0,529.0 L2488.0,517.0 2472.0,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-14" stroke-width="2px" d="M1295,527.0 C1295,177.0 2665.0,177.0 2665.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-14" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">obj</textPath>
    </text>
    <path class="displacy-arrowhead" d="M2665.0,529.0 L2673.0,517.0 2657.0,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-15" stroke-width="2px" d="M2870,527.0 C2870,177.0 4065.0,177.0 4065.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-15" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">mark</textPath>
    </text>
    <path class="displacy-arrowhead" d="M2870,529.0 L2862,517.0 2878,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-16" stroke-width="2px" d="M3045,527.0 C3045,264.5 3535.0,264.5 3535.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-16" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">det</textPath>
    </text>
    <path class="displacy-arrowhead" d="M3045,529.0 L3037,517.0 3053,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-17" stroke-width="2px" d="M3220,527.0 C3220,352.0 3530.0,352.0 3530.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-17" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">amod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M3220,529.0 L3212,517.0 3228,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-18" stroke-width="2px" d="M3395,527.0 C3395,439.5 3525.0,439.5 3525.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-18" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nmod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M3395,529.0 L3387,517.0 3403,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-19" stroke-width="2px" d="M3570,527.0 C3570,352.0 4055.0,352.0 4055.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-19" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nsubj</textPath>
    </text>
    <path class="displacy-arrowhead" d="M3570,529.0 L3562,517.0 3578,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-20" stroke-width="2px" d="M3570,527.0 C3570,439.5 3700.0,439.5 3700.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-20" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">flat</textPath>
    </text>
    <path class="displacy-arrowhead" d="M3700.0,529.0 L3708.0,517.0 3692.0,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-21" stroke-width="2px" d="M3920,527.0 C3920,439.5 4050.0,439.5 4050.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-21" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">aux</textPath>
    </text>
    <path class="displacy-arrowhead" d="M3920,529.0 L3912,517.0 3928,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-22" stroke-width="2px" d="M4095,527.0 C4095,177.0 6165.0,177.0 6165.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-22" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">advcl</textPath>
    </text>
    <path class="displacy-arrowhead" d="M4095,529.0 L4087,517.0 4103,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-23" stroke-width="2px" d="M4095,527.0 C4095,439.5 4225.0,439.5 4225.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-23" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">obj</textPath>
    </text>
    <path class="displacy-arrowhead" d="M4225.0,529.0 L4233.0,517.0 4217.0,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-24" stroke-width="2px" d="M4445,527.0 C4445,352.0 4755.0,352.0 4755.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-24" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">mark</textPath>
    </text>
    <path class="displacy-arrowhead" d="M4445,529.0 L4437,517.0 4453,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-25" stroke-width="2px" d="M4620,527.0 C4620,439.5 4750.0,439.5 4750.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-25" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">mark</textPath>
    </text>
    <path class="displacy-arrowhead" d="M4620,529.0 L4612,517.0 4628,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-26" stroke-width="2px" d="M4270,527.0 C4270,264.5 4760.0,264.5 4760.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-26" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">advcl</textPath>
    </text>
    <path class="displacy-arrowhead" d="M4760.0,529.0 L4768.0,517.0 4752.0,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-27" stroke-width="2px" d="M4970,527.0 C4970,439.5 5100.0,439.5 5100.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-27" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">det</textPath>
    </text>
    <path class="displacy-arrowhead" d="M4970,529.0 L4962,517.0 4978,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-28" stroke-width="2px" d="M5145,527.0 C5145,439.5 5275.0,439.5 5275.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-28" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nmod:poss</textPath>
    </text>
    <path class="displacy-arrowhead" d="M5145,529.0 L5137,517.0 5153,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-29" stroke-width="2px" d="M4795,527.0 C4795,352.0 5280.0,352.0 5280.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-29" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">obj</textPath>
    </text>
    <path class="displacy-arrowhead" d="M5280.0,529.0 L5288.0,517.0 5272.0,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-30" stroke-width="2px" d="M5320,527.0 C5320,439.5 5450.0,439.5 5450.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-30" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">flat</textPath>
    </text>
    <path class="displacy-arrowhead" d="M5450.0,529.0 L5458.0,517.0 5442.0,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-31" stroke-width="2px" d="M5670,527.0 C5670,264.5 6160.0,264.5 6160.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-31" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">aux</textPath>
    </text>
    <path class="displacy-arrowhead" d="M5670,529.0 L5662,517.0 5678,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-32" stroke-width="2px" d="M5845,527.0 C5845,352.0 6155.0,352.0 6155.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-32" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nsubj</textPath>
    </text>
    <path class="displacy-arrowhead" d="M5845,529.0 L5837,517.0 5853,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-33" stroke-width="2px" d="M6020,527.0 C6020,439.5 6150.0,439.5 6150.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-33" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">advmod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M6020,529.0 L6012,517.0 6028,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-34" stroke-width="2px" d="M6370,527.0 C6370,439.5 6500.0,439.5 6500.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-34" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">case</textPath>
    </text>
    <path class="displacy-arrowhead" d="M6370,529.0 L6362,517.0 6378,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-35" stroke-width="2px" d="M6195,527.0 C6195,352.0 6505.0,352.0 6505.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-35" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">obl</textPath>
    </text>
    <path class="displacy-arrowhead" d="M6505.0,529.0 L6513.0,517.0 6497.0,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-36" stroke-width="2px" d="M6720,527.0 C6720,89.5 7745.0,89.5 7745.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-36" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">mark</textPath>
    </text>
    <path class="displacy-arrowhead" d="M6720,529.0 L6712,517.0 6728,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-37" stroke-width="2px" d="M6895,527.0 C6895,177.0 7565.0,177.0 7565.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-37" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">det</textPath>
    </text>
    <path class="displacy-arrowhead" d="M6895,529.0 L6887,517.0 6903,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-38" stroke-width="2px" d="M7070,527.0 C7070,264.5 7560.0,264.5 7560.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-38" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">amod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M7070,529.0 L7062,517.0 7078,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-39" stroke-width="2px" d="M7245,527.0 C7245,439.5 7375.0,439.5 7375.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-39" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">cc</textPath>
    </text>
    <path class="displacy-arrowhead" d="M7245,529.0 L7237,517.0 7253,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-40" stroke-width="2px" d="M7070,527.0 C7070,352.0 7380.0,352.0 7380.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-40" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">conj</textPath>
    </text>
    <path class="displacy-arrowhead" d="M7380.0,529.0 L7388.0,517.0 7372.0,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-41" stroke-width="2px" d="M7595,527.0 C7595,439.5 7725.0,439.5 7725.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-41" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nsubj</textPath>
    </text>
    <path class="displacy-arrowhead" d="M7595,529.0 L7587,517.0 7603,517.0" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-168dce14ee3b4b69b37cadd4992f17f2-0-42" stroke-width="2px" d="M6195,527.0 C6195,2.0 7750.0,2.0 7750.0,527.0" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-168dce14ee3b4b69b37cadd4992f17f2-0-42" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">advcl</textPath>
    </text>
    <path class="displacy-arrowhead" d="M7750.0,529.0 L7758.0,517.0 7742.0,517.0" fill="currentColor"/>
</g>
</svg></span></div><div class="output text_html"><span class="tex2jax_ignore"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:lang="da" id="cfedf6e61063465395f743c1c0ee0ecf-0" class="displacy" width="3200" height="574.5" direction="ltr" style="max-width: none; height: 574.5px; color: #000000; background: #ffffff; font-family: Arial; direction: ltr">
<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="50">Den</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="50">DET</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="225">amerikanske</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="225">ADJ</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="400">youtuber</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="400">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="575">Logan</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="575">PROPN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="750">Paul,</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="750">PROPN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="925">der</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="925">PRON</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="1100">har</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="1100">VERB</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="1275">over</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="1275">ADP</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="1450">23</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="1450">NUM</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="1625">millioner</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="1625">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="1800">abonnenter</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="1800">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="1975">på</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="1975">ADP</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="2150">den</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="2150">DET</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="2325">sociale</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="2325">ADJ</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="2500">platform,</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="2500">NOUN</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="2675">er</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="2675">VERB</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="2850">i</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="2850">ADP</tspan>
</text>

<text class="displacy-token" fill="currentColor" text-anchor="middle" y="484.5">
    <tspan class="displacy-word" fill="currentColor" x="3025">København.</tspan>
    <tspan class="displacy-tag" dy="2em" fill="currentColor" x="3025">PROPN</tspan>
</text>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-cfedf6e61063465395f743c1c0ee0ecf-0-0" stroke-width="2px" d="M70,439.5 C70,177.0 565.0,177.0 565.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-cfedf6e61063465395f743c1c0ee0ecf-0-0" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">det</textPath>
    </text>
    <path class="displacy-arrowhead" d="M70,441.5 L62,429.5 78,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-cfedf6e61063465395f743c1c0ee0ecf-0-1" stroke-width="2px" d="M245,439.5 C245,264.5 560.0,264.5 560.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-cfedf6e61063465395f743c1c0ee0ecf-0-1" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">amod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M245,441.5 L237,429.5 253,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-cfedf6e61063465395f743c1c0ee0ecf-0-2" stroke-width="2px" d="M420,439.5 C420,352.0 555.0,352.0 555.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-cfedf6e61063465395f743c1c0ee0ecf-0-2" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nmod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M420,441.5 L412,429.5 428,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-cfedf6e61063465395f743c1c0ee0ecf-0-3" stroke-width="2px" d="M595,439.5 C595,2.0 2675.0,2.0 2675.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-cfedf6e61063465395f743c1c0ee0ecf-0-3" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nsubj</textPath>
    </text>
    <path class="displacy-arrowhead" d="M595,441.5 L587,429.5 603,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-cfedf6e61063465395f743c1c0ee0ecf-0-4" stroke-width="2px" d="M595,439.5 C595,352.0 730.0,352.0 730.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-cfedf6e61063465395f743c1c0ee0ecf-0-4" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">flat</textPath>
    </text>
    <path class="displacy-arrowhead" d="M730.0,441.5 L738.0,429.5 722.0,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-cfedf6e61063465395f743c1c0ee0ecf-0-5" stroke-width="2px" d="M945,439.5 C945,352.0 1080.0,352.0 1080.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-cfedf6e61063465395f743c1c0ee0ecf-0-5" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nsubj</textPath>
    </text>
    <path class="displacy-arrowhead" d="M945,441.5 L937,429.5 953,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-cfedf6e61063465395f743c1c0ee0ecf-0-6" stroke-width="2px" d="M595,439.5 C595,264.5 1085.0,264.5 1085.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-cfedf6e61063465395f743c1c0ee0ecf-0-6" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">acl:relcl</textPath>
    </text>
    <path class="displacy-arrowhead" d="M1085.0,441.5 L1093.0,429.5 1077.0,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-cfedf6e61063465395f743c1c0ee0ecf-0-7" stroke-width="2px" d="M1295,439.5 C1295,264.5 1610.0,264.5 1610.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-cfedf6e61063465395f743c1c0ee0ecf-0-7" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">case</textPath>
    </text>
    <path class="displacy-arrowhead" d="M1295,441.5 L1287,429.5 1303,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-cfedf6e61063465395f743c1c0ee0ecf-0-8" stroke-width="2px" d="M1470,439.5 C1470,352.0 1605.0,352.0 1605.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-cfedf6e61063465395f743c1c0ee0ecf-0-8" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nummod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M1470,441.5 L1462,429.5 1478,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-cfedf6e61063465395f743c1c0ee0ecf-0-9" stroke-width="2px" d="M1120,439.5 C1120,177.0 1615.0,177.0 1615.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-cfedf6e61063465395f743c1c0ee0ecf-0-9" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">obj</textPath>
    </text>
    <path class="displacy-arrowhead" d="M1615.0,441.5 L1623.0,429.5 1607.0,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-cfedf6e61063465395f743c1c0ee0ecf-0-10" stroke-width="2px" d="M1645,439.5 C1645,352.0 1780.0,352.0 1780.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-cfedf6e61063465395f743c1c0ee0ecf-0-10" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nmod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M1780.0,441.5 L1788.0,429.5 1772.0,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-cfedf6e61063465395f743c1c0ee0ecf-0-11" stroke-width="2px" d="M1995,439.5 C1995,177.0 2490.0,177.0 2490.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-cfedf6e61063465395f743c1c0ee0ecf-0-11" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">case</textPath>
    </text>
    <path class="displacy-arrowhead" d="M1995,441.5 L1987,429.5 2003,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-cfedf6e61063465395f743c1c0ee0ecf-0-12" stroke-width="2px" d="M2170,439.5 C2170,264.5 2485.0,264.5 2485.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-cfedf6e61063465395f743c1c0ee0ecf-0-12" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">det</textPath>
    </text>
    <path class="displacy-arrowhead" d="M2170,441.5 L2162,429.5 2178,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-cfedf6e61063465395f743c1c0ee0ecf-0-13" stroke-width="2px" d="M2345,439.5 C2345,352.0 2480.0,352.0 2480.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-cfedf6e61063465395f743c1c0ee0ecf-0-13" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">amod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M2345,441.5 L2337,429.5 2353,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-cfedf6e61063465395f743c1c0ee0ecf-0-14" stroke-width="2px" d="M1645,439.5 C1645,89.5 2495.0,89.5 2495.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-cfedf6e61063465395f743c1c0ee0ecf-0-14" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">nmod</textPath>
    </text>
    <path class="displacy-arrowhead" d="M2495.0,441.5 L2503.0,429.5 2487.0,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-cfedf6e61063465395f743c1c0ee0ecf-0-15" stroke-width="2px" d="M2870,439.5 C2870,352.0 3005.0,352.0 3005.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-cfedf6e61063465395f743c1c0ee0ecf-0-15" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">case</textPath>
    </text>
    <path class="displacy-arrowhead" d="M2870,441.5 L2862,429.5 2878,429.5" fill="currentColor"/>
</g>

<g class="displacy-arrow">
    <path class="displacy-arc" id="arrow-cfedf6e61063465395f743c1c0ee0ecf-0-16" stroke-width="2px" d="M2695,439.5 C2695,264.5 3010.0,264.5 3010.0,439.5" fill="none" stroke="currentColor"/>
    <text dy="1.25em" style="font-size: 0.8em; letter-spacing: 1px">
        <textPath xlink:href="#arrow-cfedf6e61063465395f743c1c0ee0ecf-0-16" class="displacy-label" startOffset="50%" side="left" fill="currentColor" text-anchor="middle">obl</textPath>
    </text>
    <path class="displacy-arrowhead" d="M3010.0,441.5 L3018.0,429.5 3002.0,429.5" fill="currentColor"/>
</g>
</svg></span></div></div>
</div>
<p>This is integral to the <code class="docutils literal notranslate"><span class="pre">find_descriptions</span></code> function (see <code class="docutils literal notranslate"><span class="pre">nlp_utils.py</span></code>), which:</p>
<ol class="arabic simple">
<li><p>iterates over the sentences in a document (article)</p></li>
<li><p>finds persons (entity label = <code class="docutils literal notranslate"><span class="pre">PER</span></code>)</p></li>
<li><p>for each token within the person span:</p>
<ul class="simple">
<li><p>looks at its <code class="docutils literal notranslate"><span class="pre">children</span></code> in the depdendency tree</p></li>
<li><p>if a child is an adjective (<code class="docutils literal notranslate"><span class="pre">amod</span></code>) or an apposition (<code class="docutils literal notranslate"><span class="pre">appos</span></code>), or its part of the speech is <code class="docutils literal notranslate"><span class="pre">ADJ</span></code> or <code class="docutils literal notranslate"><span class="pre">NOUN</span></code> (but it’s not a <code class="docutils literal notranslate"><span class="pre">PER</span></code> entity itself), it’s considered a descriptive word and stored.</p></li>
<li><p>it will also check the token’s <code class="docutils literal notranslate"><span class="pre">head</span></code> (governing word) for similar patterns</p></li>
</ul>
</li>
</ol>
<p>They are stored in their lemmatized and lowercased form.</p>
<p>For the sentences above, we can extract the following descriptive words:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">sents</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">find_descriptions</span><span class="p">(</span><span class="n">doc</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>defaultdict(&lt;class &#39;list&#39;&gt;, {&#39;Lily-Rose Depp&#39;: [&#39;max-serie&#39;], &quot;Abel &#39;&quot;: [&#39;hovedrolle&#39;]})
defaultdict(&lt;class &#39;list&#39;&gt;, {&#39;Nina Agdal&#39;: [&#39;trusse&#39;, &#39;\n&#39;, &#39;frækk&#39;, &#39;dansk&#39;, &#39;topmodel&#39;]})
defaultdict(&lt;class &#39;list&#39;&gt;, {&#39;Logan Paul&#39;: [&#39;amerikansk&#39;, &#39;youtuber&#39;]})
</pre></div>
</div>
</div>
</div>
<p>From here we gather that:</p>
<ul class="simple">
<li><p>Lily-Rose Depp is associated with “max-serie” (Max-series)</p></li>
<li><p>Abel has the “hovedrolle” (leading role)</p></li>
<li><p>Nina Agdal is associated with terms such as “trusse” (panties), “fræk” (hot), “dansk” (danish) and “topmodel”.</p></li>
<li><p>Logan Paul is associated with terms “amerikansk” (american) and “youtuber”</p></li>
</ul>
</section>
<section id="coreference-resolution">
<h3>Coreference Resolution<a class="headerlink" href="#coreference-resolution" title="Link to this heading">#</a></h3>
<p>Since we also want to genderize the persons (<code class="docutils literal notranslate"><span class="pre">PER</span></code>) we find, we make use of coreference resolution which is the task of gathering all expressions associated with the same entity in a document. Luckily these expressions mainly consist of pronouns, which allow us to weigh male vs. female pronouns against each other for a given person’s first name. Doing this on a global basis allow us to pool pronouns associated with a specific first name (e.g. “Camilla”) and then sum the amount of times “Camilla” is associated with a male pronoun and a female pronoun, respectively. Whichever has the largest sum, the corresponding gender is assigned to said person. Then all the persons with first-name “Camilla” is assigned to that gender.</p>
<p>The male pronouns are:</p>
<ul class="simple">
<li><p>“ham” (him)</p></li>
<li><p>“han” (he)</p></li>
<li><p>“hans” (his)</p></li>
</ul>
<p>The female pronouns are:</p>
<ul class="simple">
<li><p>“hun” (she)</p></li>
<li><p>“hende” (her)</p></li>
<li><p>“hendes” (hers)</p></li>
</ul>
<p>Naturally, this has the drawback of not considering non-binary genders, and also possibly mis-labelling gender-neutral names (e.g. “Alex”).</p>
<p>We show this in action using an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">span_group</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">spans</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">span_group</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Token indices sequence length is longer than the specified maximum sequence length for this model (550 &gt; 512). Running this sequence through the model will result in indexing errors
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>coref_clusters_1: [instruktøren, han]
coref_clusters_2: [Ny HBO Max-serie, Max-serien, den, serien, serien, serien]
coref_clusters_3: [&#39;The Idol&#39;, &#39;&#39;The Idol&#39;]
coref_clusters_4: [Lily-Rose Depp, Lily-Rose Depps, Lily-Rose Depps, hendes, &#39;The Idol&#39;, Depp, Depps, Depps, hun, &#39;The Idol&#39;, hende, Jocelyn, hun, sig selv, hun, hun, Hendes, seriens, Lily, hun, sig selv, hende, hun, hun, er, hende, sin, Sam Levinson, Rolling Stone, hende, The Idol&#39;]
coref_clusters_5: [Times&#39; film-reporter Kyle Buchanan, sin, dig, Tesfaye, mediet, Lily- Rose Depp, Rose Depp, sin, hendes, hun, Jocelyn, hende, hun, dig, Jocelyn, LA Times, han, hans, Sam Levinson, &#39;Euphoria&#39;-skaber Sam Levinson, han, Sam Levinson, Sam Levinson, Jocelyn, jeg, magasinet, Sam Levinson, han, du]
coref_clusters_6: [at der vises en scene, det, Det]
coref_clusters_7: [Lily-Rose Depps krop, showet, det, sig selv, sig]
coref_clusters_8: [glimt af potentiale, sexscenerne mellem Depp og Tesfaye, der, dem]
coref_clusters_9: [popstjernen Jocelyn, der]
coref_clusters_10: [Abel &#39;The Weeknd&#39; Tesfaye, der]
coref_clusters_11: [et hold assistenter og rådgivere, der]
coref_clusters_12: [En klassisk fortælling om kendtes nedbrud i Hollywood, der]
coref_clusters_13: [toppe, der]
coref_clusters_14: [adskillige sexscener, der, dem, optagelserne, historierne]
coref_clusters_15: [handlingen, den]
coref_clusters_16: [seriens andet afsnit, som]
coref_clusters_17: [en ti-minutters scene, hvor, den]
coref_clusters_18: [skal sutte hans p*k, det, at Sam Levinson var den bedste]
coref_clusters_19: [en scene, scenen]
coref_clusters_20: [Det, der]
coref_clusters_21: [en scene, hvor, Scenen]
coref_clusters_22: [viser, Det]
coref_clusters_23: [23-årige Lily-Rose Depp, hun, jeg, mig, mine, min, jeg, Jeg]
coref_clusters_24: [historien, artiklen]
coref_clusters_25: [min kone, vi]
coref_clusters_26: [det kreative team, teamet, de]
coref_clusters_27: [kreative ændringer, som]
coref_clusters_28: [&#39;The Idol&#39;, &#39;The Idol&#39;, &#39;The Idol&#39;
&#39;The Idol&#39;]

coref_clusters_1: [frække Nina Agdal, sig, den danske topmodel Nina Agdal, hun, hun, sin, hun, sig, Nina Agdal, hendes, Den danske fotomodel, der, sig, Nina Agdal, Nina, Hun]
coref_clusters_2: [et nyt billede, det minimale løbe-outfit, Billedet]
coref_clusters_3: [teksten &#39;Reaching for the stars&#39;, der]
coref_clusters_4: [de to strategisk placerede stjerner, som]

coref_clusters_1: [Den amerikanske youtuber Logan Paul, der, han, Logan Paul, Den 27-årige, han, Logan Paul, mig, Logan Pauls, Logan Paul, giganten med vingerne]
coref_clusters_2: [en video, der, videoen, Danske hotdogs, Artiklen]
coref_clusters_3: [stjernen, stjernen, stjernen, Internetstjernen, er, Nina Agdal, Den danske topmodel, den danske supermodel, Parret, deres]
coref_clusters_4: [et, hvor]
coref_clusters_5: [et billede, billedet]
coref_clusters_6: [den danske supermodel Nina Agdal, modellen, parret, hinanden, Logan Pauls]
coref_clusters_7: [Grækenland, hvor]
coref_clusters_8: [har gemt på mørke hemmeligheder, hele historien]
coref_clusters_9: [mørke hemmeligheder, Hemmelighederne]
</pre></div>
</div>
</div>
</div>
<p>In the coreference resolution clusters above, it makes it easy to e.g. label “Lily-Rose” and “Nina” as female names and “Logan” as a male name.</p>
</section>
<section id="sentiment-analysis">
<h3>Sentiment Analysis<a class="headerlink" href="#sentiment-analysis" title="Link to this heading">#</a></h3>
<p>A quick look at polarity:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">_</span><span class="o">.</span><span class="n">polarity</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">_</span><span class="o">.</span><span class="n">polarity_prob</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Token indices sequence length is longer than the specified maximum sequence length for this model (550 &gt; 512). Running this sequence through the model will result in indexing errors
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>neutral
{&#39;prob&#39;: array([0.007, 0.989, 0.004], dtype=float32), &#39;labels&#39;: [&#39;positive&#39;, &#39;neutral&#39;, &#39;negative&#39;]}
neutral
{&#39;prob&#39;: array([0.109, 0.882, 0.009], dtype=float32), &#39;labels&#39;: [&#39;positive&#39;, &#39;neutral&#39;, &#39;negative&#39;]}
neutral
{&#39;prob&#39;: array([0.066, 0.933, 0.002], dtype=float32), &#39;labels&#39;: [&#39;positive&#39;, &#39;neutral&#39;, &#39;negative&#39;]}
</pre></div>
</div>
</div>
</div>
</section>
<section id="nlp-dataset">
<h3>NLP Dataset<a class="headerlink" href="#nlp-dataset" title="Link to this heading">#</a></h3>
<p>The full pipeline found in <code class="docutils literal notranslate"><span class="pre">nlp.py</span></code> makes use of chunking to avoid loss of data upon out-of-memory and similar errors. The default NLP-pipe uses a batch size of 128, so it was only natural to do chunking in size of 256 which means two batches per chunk.</p>
<p>Running <code class="docutils literal notranslate"><span class="pre">nlp.py</span></code> outputs <span class="math notranslate nohighlight">\(\lceil 24191 / 256 \rceil = 95\)</span> chunks which are saved as <code class="docutils literal notranslate"><span class="pre">parquet</span></code> files. The files are then combined into a single <code class="docutils literal notranslate"><span class="pre">parquet</span></code> file after the fact. Let’s have a look at it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the processed dataset</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;dataset/articles_entertainment_nlp.parquet&quot;</span><span class="p">)</span>

<span class="c1"># Apply JSON loads to mitigate empty clusters (an issue pertained to parquet saved using PyArrow)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;coref_clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;coref_clusters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;person_descriptions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;person_descriptions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">)</span>


<span class="c1"># Relevant columns</span>
<span class="n">include_col</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;article_id&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;subtitle&quot;</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;published_time&quot;</span><span class="p">,</span> <span class="s2">&quot;ner_clusters&quot;</span><span class="p">,</span> <span class="s2">&quot;entity_groups&quot;</span><span class="p">,</span> <span class="s2">&quot;category_str&quot;</span><span class="p">,</span> <span class="s2">&quot;sentiment_score&quot;</span><span class="p">,</span> <span class="s2">&quot;sentiment_label&quot;</span><span class="p">,</span> <span class="s2">&quot;ner_clusters_lemma&quot;</span><span class="p">,</span> <span class="s2">&quot;coref_clusters&quot;</span><span class="p">,</span> <span class="s2">&quot;emotion&quot;</span><span class="p">,</span> <span class="s2">&quot;hate_speech&quot;</span><span class="p">,</span> <span class="s2">&quot;person_descriptions&quot;</span><span class="p">]</span>

<span class="n">include_col</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;article_id&#39;,
 &#39;title&#39;,
 &#39;subtitle&#39;,
 &#39;body&#39;,
 &#39;published_time&#39;,
 &#39;ner_clusters&#39;,
 &#39;entity_groups&#39;,
 &#39;category_str&#39;,
 &#39;sentiment_score&#39;,
 &#39;sentiment_label&#39;,
 &#39;ner_clusters_lemma&#39;,
 &#39;coref_clusters&#39;,
 &#39;emotion&#39;,
 &#39;hate_speech&#39;,
 &#39;person_descriptions&#39;]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="person-name-processing">
<h2>🪪 Person Name Processing<a class="headerlink" href="#person-name-processing" title="Link to this heading">#</a></h2>
<section id="alias-assignment">
<h3>Alias Assignment<a class="headerlink" href="#alias-assignment" title="Link to this heading">#</a></h3>
<p>We need to take into account that a person can be known under multiple identities or aliases. This can be anything from a nickname to an abbreviation or shortening of the original name, and even a misspelled variant of the name. E.g.: “Mads Mikkelsen” may be referred to as “Mads”, “Mikkelsen” or “Mads Mikkelsen” in articles related to him.</p>
<p>This will allow us to gather information from coreference resolution clusters and person descriptions using their canonical name as well as their aliases. To speed up computations, we make a new column where we collect the lemmatized variants of person names and remove duplicates by converting the NER cluster to a set:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make a new persons column</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;persons&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span>
        <span class="n">entity</span> 
        <span class="k">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">group</span> 
        <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ner_clusters_lemma&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;entity_groups&#39;</span><span class="p">])</span> 
        <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;PER&#39;</span>
    <span class="p">)),</span> <span class="c1"># make a set</span>
    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># To see the difference between this and the regular NER cluster</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;persons&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;ner_clusters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;Tom Hanks&#39;, &#39;David Gardner&#39;, &#39;Lewes&#39;, &#39;Samantha Lewes&#39;, &#39;Hanks&#39;, &#39;Samantha&#39;]

[&#39;Tom Hanks&#39; &#39;Samantha Lewes&#39; &#39;David Gardner&#39; &#39;Samantha&#39; &#39;Hanks&#39;
 &#39;Samantha Lewes&#39; &#39;SFGate.com&#39; &#39;Hanks&#39; &#39;Lewes&#39; &#39;Tom Hanks&#39;
 &#39;Samantha Lewes&#39;]
</pre></div>
</div>
</div>
</div>
<p>To get rid of incorrectly classified persons, we run it through a simple algorithm found in <code class="docutils literal notranslate"><span class="pre">nlp_utils.py</span></code>:</p>
<p><strong>Examples:</strong></p>
<ul class="simple">
<li><p>“_Tom hanks$” → “Tom hanks”</p></li>
<li><p>“A<span class="math notranslate nohighlight">\(Ap Rocky&quot; → &quot;A\)</span>Ap Rocky” (preserves internal $)</p></li>
<li><p>“Jonas123” → None (numbers)</p></li>
<li><p>“magasin” → None (no capital)</p></li>
<li><p>“Chefredaktør…Hansen” → None (&gt;6 words)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apply algorithm for all persons in all rows</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;persons&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;persons&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">clean_list</span><span class="p">)</span>

<span class="c1"># Remove rows with no persons</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;persons&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>
</pre></div>
</div>
</div>
</div>
<p>We then create an entirely new dataframe with a person’s:</p>
<ul class="simple">
<li><p>canonical name</p></li>
<li><p>aliases</p></li>
<li><p>coference resolution clusters (also based on aliases)</p></li>
<li><p>descriptions (also based on aliases)</p></li>
</ul>
<p>It uses <code class="docutils literal notranslate"><span class="pre">WRatio</span></code>, which is weighted fuzzysearch based on multiple algorithms, to match similar names and find the cannonical name (the longest permutation of the name). See the full algorithm rundown in <code class="docutils literal notranslate"><span class="pre">nlp_utils.py</span></code>.</p>
<p>In essence, it makes it so that the coreference resolution clusters and descriptions for the aliases are all assigned to the cannonical name on a per-article basis. We tried making this work on a global basis, but similar names would incorrectly overlap (e.g. “Frederik Fetterlein” may be absorbed by “Kronprins Frederik”).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make a copy of the original df</span>
<span class="n">df_copy</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Apply the alias assignment algorithm</span>
<span class="n">result_df</span> <span class="o">=</span> <span class="n">process_person_entities</span><span class="p">(</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df_copy</span><span class="p">,</span>
    <span class="n">name_col</span><span class="o">=</span><span class="s1">&#39;persons&#39;</span><span class="p">,</span>
    <span class="n">desc_col</span><span class="o">=</span><span class="s1">&#39;person_descriptions&#39;</span><span class="p">,</span>
    <span class="n">coref_col</span><span class="o">=</span><span class="s1">&#39;coref_clusters&#39;</span><span class="p">,</span>
    <span class="n">article_id_col</span><span class="o">=</span><span class="s1">&#39;article_id&#39;</span><span class="p">,</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mi">85</span>
    <span class="p">)</span>

<span class="n">result_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>canonical_name</th>
      <th>aliases</th>
      <th>article_ids</th>
      <th>person_descriptions</th>
      <th>coref_clusters</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2Pac</td>
      <td>[2Pac]</td>
      <td>[8036103]</td>
      <td>{}</td>
      <td>{}</td>
    </tr>
    <tr>
      <th>1</th>
      <td>50 Cent</td>
      <td>[50 Cent, Cent]</td>
      <td>[5526970, 7471914, 9027180, 9040583, 9284886]</td>
      <td>{9027180: ['rapper', 'kommentar', 'jaloux'], 9...</td>
      <td>{5526970: {'coref_clusters_1': ['rap-stjernen ...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9Lokknine</td>
      <td>[9Lokknine]</td>
      <td>[8215769]</td>
      <td>{}</td>
      <td>{}</td>
    </tr>
    <tr>
      <th>3</th>
      <td>A$Ap Rocky</td>
      <td>[A$Ap Rocky]</td>
      <td>[9072105, 9261435, 9519532, 9557462, 9637604, ...</td>
      <td>{}</td>
      <td>{}</td>
    </tr>
    <tr>
      <th>4</th>
      <td>A. A. Milne</td>
      <td>[A. A. Milne]</td>
      <td>[9271783, 9528054]</td>
      <td>{}</td>
      <td>{}</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>34229</th>
      <td>Øyvind Ougaard</td>
      <td>[Øyvind, Øyvind Ougaard]</td>
      <td>[5853745, 6355881, 6356071, 7259006]</td>
      <td>{6356071: ['glad'], 7259006: ['kapelmester', '...</td>
      <td>{6356071: {'coref_clusters_5': ['Ole Fick', 'Ø...</td>
    </tr>
    <tr>
      <th>34230</th>
      <td>Øyvind Rønning</td>
      <td>[Øyvind Rønning]</td>
      <td>[9761725]</td>
      <td>{9761725: ['anmelder']}</td>
      <td>{9761725: {'coref_clusters_15': ['anmelder Øyv...</td>
    </tr>
    <tr>
      <th>34231</th>
      <td>Øyvind Skovli</td>
      <td>[Øyvind Skovli]</td>
      <td>[4219754]</td>
      <td>{4219754: ['informationskonsulent']}</td>
      <td>{4219754: {'coref_clusters_11': ['informations...</td>
    </tr>
    <tr>
      <th>34232</th>
      <td>Øztergaard</td>
      <td>[Øztergaard]</td>
      <td>[4941288]</td>
      <td>{4941288: ['figur']}</td>
      <td>{}</td>
    </tr>
    <tr>
      <th>34233</th>
      <td>Úrsula Corberó</td>
      <td>[Úrsula Corberó]</td>
      <td>[8224621, 8225109]</td>
      <td>{8224621: ['skuespiller'], 8225109: ['skuespil...</td>
      <td>{}</td>
    </tr>
  </tbody>
</table>
<p>34234 rows × 5 columns</p>
</div></div></div>
</div>
<p>It works by returning a DataFrame in which it:</p>
<ol class="arabic simple">
<li><p>Extracts descriptions for entities (PER)</p>
<ul class="simple">
<li><p>Example: Tom Hanks [“Cool”, “Bad”], Hanks, [“Angry”].</p>
<ul>
<li><p>Then when Tom Hanks and Hanks are merged -&gt; Tom Hanks [“Cool”, “Bad”, “Angry]</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Merges simmilar names (using a threshold of 0.85)</p></li>
<li><p>Merges and maps all information from aliases to the canonical name</p></li>
</ol>
</section>
<section id="genderization">
<h3>Genderization<a class="headerlink" href="#genderization" title="Link to this heading">#</a></h3>
<p>In order for us to genderize we must use the coref_clusters that are assigned to each as described in section “Coreference Resolution”.</p>
<p>We are using the genderization function implemented in <code class="docutils literal notranslate"><span class="pre">nlp_utils.py</span></code>.</p>
<ul class="simple">
<li><p>First we define the male and female pronouns</p></li>
<li><p>Then we keep track of each pronoun in coref_clusters and assign a gender to the current canonical_name</p></li>
<li><p>We then support the descision using the aliases from the articles.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gendered_df</span> <span class="o">=</span> <span class="n">genderization</span><span class="p">(</span><span class="n">result_df</span><span class="p">)</span>
<span class="n">gendered_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>canonical_name</th>
      <th>aliases</th>
      <th>article_ids</th>
      <th>person_descriptions</th>
      <th>coref_clusters</th>
      <th>gender</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2Pac</td>
      <td>[2Pac]</td>
      <td>[8036103]</td>
      <td>{}</td>
      <td>{}</td>
      <td>unknown</td>
    </tr>
    <tr>
      <th>1</th>
      <td>50 Cent</td>
      <td>[50 Cent, Cent]</td>
      <td>[5526970, 7471914, 9027180, 9040583, 9284886]</td>
      <td>{9027180: ['rapper', 'kommentar', 'jaloux'], 9...</td>
      <td>{5526970: {'coref_clusters_1': ['rap-stjernen ...</td>
      <td>female</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9Lokknine</td>
      <td>[9Lokknine]</td>
      <td>[8215769]</td>
      <td>{}</td>
      <td>{}</td>
      <td>unknown</td>
    </tr>
    <tr>
      <th>3</th>
      <td>A$Ap Rocky</td>
      <td>[A$Ap Rocky]</td>
      <td>[9072105, 9261435, 9519532, 9557462, 9637604, ...</td>
      <td>{}</td>
      <td>{}</td>
      <td>unknown</td>
    </tr>
    <tr>
      <th>4</th>
      <td>A. A. Milne</td>
      <td>[A. A. Milne]</td>
      <td>[9271783, 9528054]</td>
      <td>{}</td>
      <td>{}</td>
      <td>male</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>34229</th>
      <td>Øyvind Ougaard</td>
      <td>[Øyvind, Øyvind Ougaard]</td>
      <td>[5853745, 6355881, 6356071, 7259006]</td>
      <td>{6356071: ['glad'], 7259006: ['kapelmester', '...</td>
      <td>{6356071: {'coref_clusters_5': ['Ole Fick', 'Ø...</td>
      <td>male</td>
    </tr>
    <tr>
      <th>34230</th>
      <td>Øyvind Rønning</td>
      <td>[Øyvind Rønning]</td>
      <td>[9761725]</td>
      <td>{9761725: ['anmelder']}</td>
      <td>{9761725: {'coref_clusters_15': ['anmelder Øyv...</td>
      <td>male</td>
    </tr>
    <tr>
      <th>34231</th>
      <td>Øyvind Skovli</td>
      <td>[Øyvind Skovli]</td>
      <td>[4219754]</td>
      <td>{4219754: ['informationskonsulent']}</td>
      <td>{4219754: {'coref_clusters_11': ['informations...</td>
      <td>male</td>
    </tr>
    <tr>
      <th>34232</th>
      <td>Øztergaard</td>
      <td>[Øztergaard]</td>
      <td>[4941288]</td>
      <td>{4941288: ['figur']}</td>
      <td>{}</td>
      <td>unknown</td>
    </tr>
    <tr>
      <th>34233</th>
      <td>Úrsula Corberó</td>
      <td>[Úrsula Corberó]</td>
      <td>[8224621, 8225109]</td>
      <td>{8224621: ['skuespiller'], 8225109: ['skuespil...</td>
      <td>{}</td>
      <td>unknown</td>
    </tr>
  </tbody>
</table>
<p>34234 rows × 6 columns</p>
</div></div></div>
</div>
<p>To filter out “lesser significant” figures/persons, we keep only persons who’re mentioned in 5 articles or more:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add a new column &#39;num_articles&#39; that stores the count of articles for each person</span>
<span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;num_articles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;article_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span>

<span class="c1"># Sort the DataFrame by the &#39;num_articles&#39; column in descending order (to get the person with the most articles first)</span>
<span class="n">names_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;num_articles&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Show the sorted result_df</span>
<span class="n">names_df</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="n">names_df</span><span class="p">[</span><span class="s2">&quot;num_articles&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">names_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>canonical_name</th>
      <th>aliases</th>
      <th>article_ids</th>
      <th>person_descriptions</th>
      <th>coref_clusters</th>
      <th>gender</th>
      <th>num_articles</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Dronning Margrethe</td>
      <td>[Dronning, Dronning Magrethe, Dronning Margret...</td>
      <td>[3038521, 3056484, 3077475, 3079947, 3084765, ...</td>
      <td>{3193653: ['farmor', 'dronning'], 3196007: ['c...</td>
      <td>{3056484: {'coref_clusters_5': ['Dronning Marg...</td>
      <td>female</td>
      <td>408</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Joachim</td>
      <td>[Joachim, Joacim]</td>
      <td>[3061656, 3082698, 3083145, 3083699, 3084765, ...</td>
      <td>{3061656: ['prins', 'prinsesse', '
'], 3082698...</td>
      <td>{3061656: {'coref_clusters_1': ['Hun', 'Hun', ...</td>
      <td>male</td>
      <td>379</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Henrik</td>
      <td>[Henri, Henrik]</td>
      <td>[3038205, 3038521, 3056484, 3079947, 3087749, ...</td>
      <td>{3038205: ['indflytter', 'år', 'mand'], 303852...</td>
      <td>{3038205: {'coref_clusters_5': ['Henrik på 39 ...</td>
      <td>male</td>
      <td>330</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Kronprins Frederik</td>
      <td>[Frede, Frederik, Frederik Og, Kronprins, Kron...</td>
      <td>[3041066, 3079947, 3083793, 3085326, 3187038, ...</td>
      <td>{3191251: ['ynder', 'kæreste', 'ynder', 'kæres...</td>
      <td>{3191251: {'coref_clusters_1': ['kronprins Fre...</td>
      <td>male</td>
      <td>271</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Casper Christensen</td>
      <td>[Cajsa Christensen, Caper Christensen, Casper,...</td>
      <td>[3103407, 3198301, 3227493, 4003217, 4006373, ...</td>
      <td>{3103407: ['trio', 'tæskehold'], 3198301: ['ma...</td>
      <td>{3198301: {'coref_clusters_1': ['komikeren Fra...</td>
      <td>male</td>
      <td>259</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>4163</th>
      <td>Per Wahlöö</td>
      <td>[Per Wahlöö]</td>
      <td>[3001457, 4209072, 4782681, 4800307, 5909312]</td>
      <td>{3001457: ['roman']}</td>
      <td>{}</td>
      <td>male</td>
      <td>5</td>
    </tr>
    <tr>
      <th>4164</th>
      <td>Rob Lowe</td>
      <td>[Rob Lowe]</td>
      <td>[4342229, 4974358, 5894327, 9414008, 9703497]</td>
      <td>{4342229: ['babysitter', 'teenageidol']}</td>
      <td>{4342229: {'coref_clusters_1': ['Rob Lowe', 'd...</td>
      <td>male</td>
      <td>5</td>
    </tr>
    <tr>
      <th>4165</th>
      <td>Ingolf Gabold</td>
      <td>[Ingolf Gabold]</td>
      <td>[3202258, 3205984, 4301787, 4435845, 5432375]</td>
      <td>{3202258: ['dramachef'], 4301787: ['dramachef'...</td>
      <td>{3205984: {'coref_clusters_3': ['hiver tv-chef...</td>
      <td>male</td>
      <td>5</td>
    </tr>
    <tr>
      <th>4166</th>
      <td>Tonny</td>
      <td>[Tonny]</td>
      <td>[4388278, 4817461, 4896615, 6263203, 9723598]</td>
      <td>{4388278: ['hovedperson', 'barn', 'sjæl', 'kar...</td>
      <td>{4388278: {'coref_clusters_1': ['instruktøren ...</td>
      <td>male</td>
      <td>5</td>
    </tr>
    <tr>
      <th>4167</th>
      <td>Perez Hilton</td>
      <td>[Perez, Perez Hilton]</td>
      <td>[4440513, 4751258, 6297688, 8159434, 8642432]</td>
      <td>{4440513: ['kendis-blogger'], 4751258: ['
'], ...</td>
      <td>{4440513: {'coref_clusters_20': ['har Lohan if...</td>
      <td>unknown</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
<p>4168 rows × 7 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gender_counts</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">gender_percent</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="c1"># Set style</span>
<span class="c1">#sns.set_style(&quot;whitegrid&quot;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">palette</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;male&#39;</span><span class="p">:</span> <span class="s1">&#39;#3498db&#39;</span><span class="p">,</span>   
    <span class="s1">&#39;female&#39;</span><span class="p">:</span> <span class="s1">&#39;#e74c3c&#39;</span><span class="p">,</span>  
    <span class="s1">&#39;unknown&#39;</span><span class="p">:</span> <span class="s1">&#39;#95a5a6&#39;</span>  
<span class="p">}</span>

<span class="c1"># Plot</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">gender_counts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">gender_counts</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">palette</span><span class="o">=</span><span class="p">[</span><span class="n">palette</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gender_counts</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Add value labels on top of bars</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">patches</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="se">\n</span><span class="s1">(</span><span class="si">{</span><span class="n">gender_percent</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">gender_counts</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%)&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">get_height</span><span class="p">()),</span>
        <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span>
    <span class="p">)</span>

<span class="c1"># Customize appearance</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Gender Distribution&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Gender&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># Remove top and right spines</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>

<span class="c1"># Add some padding</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;website/figures/gender-dist.svg&quot;</span><span class="p">)</span>

<span class="c1"># Show plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9870ff84938b73c49052561190adaeeb976232c20214d3d35224388905bb8f07.png" src="_images/9870ff84938b73c49052561190adaeeb976232c20214d3d35224388905bb8f07.png" />
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="network">
<h2>👨‍👩‍👧‍👦 Network<a class="headerlink" href="#network" title="Link to this heading">#</a></h2>
<section id="creation-of-co-mention-network">
<h3>Creation of co-mention network<a class="headerlink" href="#creation-of-co-mention-network" title="Link to this heading">#</a></h3>
<p>The network we make is something we call co-mention network.</p>
<p><code class="docutils literal notranslate"><span class="pre">Node:</span> <span class="pre">canonical_name</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">Edge:</span> <span class="pre">if</span> <span class="pre">two</span> <span class="pre">canonical_names</span> <span class="pre">share</span> <span class="pre">same</span> <span class="pre">article_id</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">Edge-weight:</span> <span class="pre">Number</span> <span class="pre">of</span> <span class="pre">distinct</span> <span class="pre">articles</span> <span class="pre">shared</span></code></p>
<p><strong>Note:</strong> We only keep edges with weight &gt; 2. e.g., two people can briefly get mentioned in one article. But never mention each other again. This will introduce a lot of noise, since EB-nerd has some article errors that introduces “appetizers” to other article by briefly naming other article titles in the body text (that can include names). Overall, this gave better results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">network_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">network_summary</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">network_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_co_mention_graph</span>

<span class="n">graph</span> <span class="o">=</span> <span class="n">create_co_mention_graph</span><span class="p">(</span><span class="n">names_df</span><span class="p">)</span>

<span class="c1">#Run summary statistics of graph</span>
<span class="n">summary</span><span class="p">,</span> <span class="n">degrees</span><span class="p">,</span> <span class="n">centrality</span> <span class="o">=</span> <span class="n">network_summary</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>  

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NETWORK SUMMARY STATISTICS&quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;TOP 5 MOST CONNECTED NODES&quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">degrees</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Degree&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>            NETWORK SUMMARY STATISTICS            
        Metric    Value
         Nodes 2347.000
         Edges 8606.000
Average Degree    7.334

            TOP 5 MOST CONNECTED NODES            

                    Degree
Dronning Margrethe     117
Joachim                114
Henrik                 100
Frederik                89
Christian               87
</pre></div>
</div>
</div>
</div>
<p>Its now possible to visulise the network</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">netwulf</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nw</span>


<span class="c1"># Create visualization and get styled network data</span>
<span class="n">styled_network</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">,</span>
    <span class="n">port</span><span class="o">=</span><span class="mi">420</span><span class="p">,</span>  <span class="c1"># Run in headless mode</span>
    <span class="n">plot_in_cell_below</span><span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The plot uses netwulf, and opens in a external window. Under is a picture embedded of it. The size of the nodes varies by the strength. That means the bigger the node, the more co-mentions</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image</span> <span class="o">=</span> <span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;pictures/graph1.png&#39;</span><span class="p">)</span>

<span class="c1"># Set a higher DPI and larger figsize</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>  <span class="c1"># Increase dpi for finer control</span>

<span class="c1"># Display image with manual scaling</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>  <span class="c1"># Stretch to fit (xmin, xmax, ymin, ymax)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7605d9afda679d830caf0e571456fd10058bb76baf373dedbbc49023e2dcae7f.png" src="_images/7605d9afda679d830caf0e571456fd10058bb76baf373dedbbc49023e2dcae7f.png" />
</div>
</div>
</section>
<section id="analysis-of-co-mention-graph">
<h3>Analysis of co-mention graph<a class="headerlink" href="#analysis-of-co-mention-graph" title="Link to this heading">#</a></h3>
<section id="powerlaw-and-top-hubs">
<h4>Powerlaw and top-hubs:<a class="headerlink" href="#powerlaw-and-top-hubs" title="Link to this heading">#</a></h4>
<p>First we are interested in checking if our network follows a power-law distribution. We do this by using the libary powerlaw</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Step 1: Get degrees </span>
<span class="n">degrees</span> <span class="o">=</span> <span class="p">[</span><span class="n">deg</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">deg</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">degree</span><span class="p">()]</span>

<span class="c1"># Step 2: Fit power-law model</span>
<span class="n">fit</span> <span class="o">=</span> <span class="n">powerlaw</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">degrees</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Step 3: Print alpha (power-law exponent) </span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alpha (power-law exponent): </span><span class="si">{</span><span class="n">fit</span><span class="o">.</span><span class="n">power_law</span><span class="o">.</span><span class="n">alpha</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Step 4: Compare with other distributions</span>
<span class="n">R</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">distribution_compare</span><span class="p">(</span><span class="s1">&#39;power_law&#39;</span><span class="p">,</span> <span class="s1">&#39;exponential&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Log-likelihood ratio (vs exponential): R = </span><span class="si">{</span><span class="n">R</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p = </span><span class="si">{</span><span class="n">p</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">R</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Power-law is a significantly better fit than exponential.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Power-law is NOT a significantly better fit than exponential.&quot;</span><span class="p">)</span>


<span class="n">fig</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">plot_ccdf</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Empirical data&#39;</span><span class="p">)</span>
<span class="n">fit</span><span class="o">.</span><span class="n">power_law</span><span class="o">.</span><span class="n">plot_ccdf</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Power law fit&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Degree Distribution CCDF&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Degree&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;P(X ≥ x)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Alpha (power-law exponent): 3.2587

Log-likelihood ratio (vs exponential): R = 23.0994, p = 0.0013
Power-law is a significantly better fit than exponential.
</pre></div>
</div>
<img alt="_images/fa4a97331a6fdcc889c45d826c5bae44537fc17257b593b8ebadf1ded22c851a.png" src="_images/fa4a97331a6fdcc889c45d826c5bae44537fc17257b593b8ebadf1ded22c851a.png" />
</div>
</div>
<p><strong>The richer-gets-richer effect:</strong></p>
<ul class="simple">
<li><p>In this co-mention network, most persons are only occasionally mentioned alongside others, but a small number (e.g., celebrities) appear in many different articles. These high-degree nodes act as hubs, not necessarily because articles are about them, but because they are repeatedly co-mentioned with a wide range of others articles. Their celebrity status makes them more likely to be mentioned again.</p></li>
</ul>
<p>This means that if our data analysis capture a few of the top celebrities (either though communities or greedily adding to data), much of the media discourse can be analyzed using a few top candidates and their connections since they have lots of media coverage.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Top 20 hubs and their gender proportions</span>
<span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">degree_centrality</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[:</span><span class="mi">20</span><span class="p">]]</span>
<span class="n">gender_proportions</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="n">names_df</span><span class="p">[</span><span class="s2">&quot;canonical_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">top_names</span><span class="p">)][</span><span class="s2">&quot;gender&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top hub gender proportions:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">gender_proportions</span><span class="p">)</span>

<span class="c1"># Degree stats by gender for all nodes in graph</span>
<span class="n">node_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;canonical_name&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">())})</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">names_df</span><span class="p">[[</span><span class="s1">&#39;canonical_name&#39;</span><span class="p">,</span> <span class="s1">&#39;gender&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;canonical_name&#39;</span><span class="p">)</span>
<span class="n">node_data</span><span class="p">[</span><span class="s1">&#39;degree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_data</span><span class="p">[</span><span class="s1">&#39;canonical_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">degree</span><span class="p">()))</span>
<span class="n">gender_stats</span> <span class="o">=</span> <span class="n">node_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;gender&#39;</span><span class="p">)[</span><span class="s1">&#39;degree&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;count&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Degree stats by gender:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">gender_stats</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Top hub gender proportions:
 gender
male      0.55
female    0.45
Name: proportion, dtype: float64
Degree stats by gender:
          count
gender        
female    1018
male      1291
unknown     38
</pre></div>
</div>
</div>
</div>
<p>The fact that men and women are almost equally represented among the top hubs means women are clearly part of the conversation, but to really understand how gender plays out in the language, we need to analyse even further.</p>
<p><strong>Note</strong> We have filthered out alot of unnecessary nodes, thats why the gender count have fallen.</p>
</section>
<section id="random-network-or-tendency">
<h4>Random network or tendency?:<a class="headerlink" href="#random-network-or-tendency" title="Link to this heading">#</a></h4>
<p>Does our network actually capture a social pattern? To check we must construct a random network from our graph by doing double-edge-swap and compare <code class="docutils literal notranslate"><span class="pre">degree_assortativity_coefficient</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nx</span><span class="o">.</span><span class="n">degree_assortativity_coefficient</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.08075645653271298
</pre></div>
</div>
</div>
</div>
<p>Assortativity measures the similarity of connections in the graph with respect to the node degree. (nx-docs).</p>
<p>the graph gets positive degree assortativity: high-degree nodes tend to connect (slightly) more with other high-degree nodes. Also supported by the richer gets richer effect shown. (certain celebrities captures the media spotlight)</p>
<p><strong>Double-edge-swap test</strong>
We then do the double-edge-swap test <span class="math notranslate nohighlight">\(10 \times 8591\)</span>(edges) a hundred times and compare the swapped network to the social network.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>

<span class="n">r_real</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">degree_assortativity_coefficient</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

<span class="c1"># Parameters</span>
<span class="n">n_randomizations</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">nswap</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">graph</span><span class="o">.</span><span class="n">number_of_edges</span><span class="p">()</span>
<span class="n">max_tries</span> <span class="o">=</span> <span class="n">nswap</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">seed</span> <span class="o">=</span> <span class="mi">4</span>

<span class="c1"># Store assortativity va lues from randomized graphs</span>
<span class="n">r_random</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_randomizations</span><span class="p">):</span>
    <span class="n">H_copy</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Perform edge swaps while preserving degree sequence</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">double_edge_swap</span><span class="p">(</span><span class="n">H_copy</span><span class="p">,</span> <span class="n">nswap</span><span class="o">=</span><span class="n">nswap</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="n">max_tries</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">degree_assortativity_coefficient</span><span class="p">(</span><span class="n">H_copy</span><span class="p">)</span>
    <span class="n">r_random</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="c1"># Compute mean and std of the null distribution</span>
<span class="n">mean_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r_random</span><span class="p">)</span>
<span class="n">std_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">r_random</span><span class="p">)</span>

<span class="c1"># Z-score and (two-tailed) p-value</span>
<span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_real</span> <span class="o">-</span> <span class="n">mean_r</span><span class="p">)</span> <span class="o">/</span> <span class="n">std_r</span>
<span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)))</span>  <span class="c1"># Two-tailed test</span>

<span class="c1"># Results</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real assortativity: </span><span class="si">{</span><span class="n">r_real</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random mean: </span><span class="si">{</span><span class="n">mean_r</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, std: </span><span class="si">{</span><span class="n">std_r</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reject H0. Do not reject H1&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Real assortativity: 0.0808
Random mean: -0.0270, std: 0.0080
Reject H0. Do not reject H1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">r_random</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Null distribution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">r_real</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Real assortativity (</span><span class="si">{</span><span class="n">r_real</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Assortativity Null Distribution vs Real Value&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Assortativity Coefficient&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0441cdd22f4d3800e4bb519987e562b3b9915330d98e9e0226dc3f30534fdf49.png" src="_images/0441cdd22f4d3800e4bb519987e562b3b9915330d98e9e0226dc3f30534fdf49.png" />
</div>
</div>
<p>This indicates that the assortativity coefficient from the randomized networks generated from the real graph stats are indeed far away from the real graph. In other words, the real graph structure wrt. the assortativity coefficient is not randomized and carries a proper non-randomized order.</p>
<p>We can clearly reject the null hypothethis that our social network dosent capture any tendencies, and accept the secondary hypothethis. So we cannot reject that our graph captures a tendency.</p>
</section>
</section>
<section id="community-detection">
<h3>Community detection<a class="headerlink" href="#community-detection" title="Link to this heading">#</a></h3>
<p>In order to detect communties, we are interrested in finding the ones that maximizes modelarity. ( higher modularity indicates a more pronounced community structure).</p>
<p>We are using a louvain_based comunity detection, but we have applied a bunch of adhoc filters as hypterparameters.</p>
<p>This is how the algorithm works step by step:</p>
<ol class="arabic simple">
<li><p>Run multiple times (R = 50)</p>
<ul class="simple">
<li><p>We shuffle the edges (keep the structure, but not list sequence)</p></li>
<li><p>Filther out edges with weight &gt; 4 (We are interested in smaller communties, but with weight smaller than 4 we risk getting large non-meaningfull partition)</p></li>
<li><p>Do best_partition (tuned using resultion which values bias toward smaller communities)</p></li>
</ul>
</li>
<li><p>Keep the best_partition that maxemises modularity</p></li>
<li><p>Post processing</p>
<ul class="simple">
<li><p>We pick the highest degree celeb in each partition called <code class="docutils literal notranslate"><span class="pre">seed</span></code>, which should be a hub (the community revolves about them)</p></li>
<li><p>For each node, check that its <code class="docutils literal notranslate"><span class="pre">internal</span> <span class="pre">edge</span> <span class="pre">weight</span> <span class="pre">/</span> <span class="pre">total</span> <span class="pre">edge</span> <span class="pre">weight</span> <span class="pre">≥</span> <span class="pre">cohesion_ratio</span></code></p></li>
<li><p>Further filter to keep only nodes with at least 2 neighbors within the filtered community.</p></li>
</ul>
</li>
</ol>
<p>This way we make the louvain create communties that went from very large partitions, to medium-small sized.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">top_communities</span> <span class="o">=</span> <span class="n">louvain_based_communities_randomized</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">,</span>
    <span class="n">runs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">top_k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">weight_threshold</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>     <span class="c1"># moderate filtering</span>
    <span class="n">cohesion_ratio</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>     <span class="c1"># slightly more permissive</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">69</span><span class="p">,</span>
    <span class="n">res</span><span class="o">=</span><span class="mf">1.50</span>                 <span class="c1"># lower resolution for bigger communities</span>
<span class="p">)</span>

<span class="c1"># Display results</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">comm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_communities</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">members</span> <span class="o">=</span> <span class="p">[(</span><span class="n">n</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">graph</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;members&#39;</span><span class="p">]]</span>
    <span class="n">members_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">members</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]</span>

    <span class="n">density</span> <span class="o">=</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;internal_edges&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">comm</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">comm</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">1e-9</span><span class="p">)</span>
    <span class="n">boundary_edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">edge_boundary</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;members&#39;</span><span class="p">]))</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Community </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> (Seed: </span><span class="si">{</span><span class="n">comm</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Size: </span><span class="si">{</span><span class="n">comm</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> | Internal Strength: </span><span class="si">{</span><span class="n">comm</span><span class="p">[</span><span class="s1">&#39;internal_edges&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Density: </span><span class="si">{</span><span class="n">density</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> | Boundary Edges: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">boundary_edges</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top Members [Name | Degree | Total Co-mentions]:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">deg</span><span class="p">,</span> <span class="n">strength</span> <span class="ow">in</span> <span class="n">members_sorted</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">deg</span><span class="si">:</span><span class="s2">3</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">strength</span><span class="si">:</span><span class="s2">5</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Community 1 (Seed: Joachim)
Size: 104 | Internal Strength: 6801
Density: 1.27 | Boundary Edges: 530
Top Members [Name | Degree | Total Co-mentions]:
  Dronning Margrethe   117 |  1310
  Joachim              114 |  1641
  Henrik               100 |  1128
  Frederik              89 |   741
  Christian             87 |   683

Community 2 (Seed: Harry)
Size: 41 | Internal Strength: 1595
Density: 1.95 | Boundary Edges: 182
Top Members [Name | Degree | Total Co-mentions]:
  Harry                 47 |   538
  Dronning Elizabeth    42 |   370
  William               42 |   349
  Philip                37 |   200
  Kong Charles          34 |   297

Community 3 (Seed: Geggo)
Size: 24 | Internal Strength: 676
Density: 2.45 | Boundary Edges: 113
Top Members [Name | Degree | Total Co-mentions]:
  Geggo                 38 |   335
  Linse Kessler         34 |   232
  Stephanie             32 |   219
  Mikkel Kessler        22 |   127
  Mikkel                21 |   108

Community 4 (Seed: Silas Holst)
Size: 104 | Internal Strength: 2185
Density: 0.41 | Boundary Edges: 337
Top Members [Name | Degree | Total Co-mentions]:
  Silas Holst           84 |   480
  Mascha Vang           54 |   300
  Christiane Schaumburg-Müller  40 |   211
  Sarah Grünewald       38 |   185
  Thomas Evers Poulsen  36 |   203

Community 5 (Seed: Nikolaj Lie Kaas)
Size: 119 | Internal Strength: 2187
Density: 0.31 | Boundary Edges: 379
Top Members [Name | Degree | Total Co-mentions]:
  Nikolaj Lie Kaas      57 |   314
  Trine Dyrholm         54 |   251
  Mads Mikkelsen        53 |   258
  Bodil Jørgensen       47 |   214
  Lars Von Trier        44 |   229

Community 6 (Seed: Christopher)
Size: 95 | Internal Strength: 1730
Density: 0.39 | Boundary Edges: 317
Top Members [Name | Degree | Total Co-mentions]:
  Christopher           57 |   357
  Medina                55 |   322
  Alexander             54 |   258
  Christian Kjær        32 |   266
  Caroline Fleming      25 |   147

Community 7 (Seed: Thomas Helmig)
Size: 12 | Internal Strength: 217
Density: 3.29 | Boundary Edges: 17
Top Members [Name | Degree | Total Co-mentions]:
  Thomas Helmig         20 |   156
  Renée Toft Simonsen   13 |   115
  Hugo Helmig            7 |    75
  Søs Fenger             5 |    25
  Hugo                   5 |    23

Community 8 (Seed: Oliver Bjerrehuus)
Size: 81 | Internal Strength: 1207
Density: 0.37 | Boundary Edges: 280
Top Members [Name | Degree | Total Co-mentions]:
  Oliver Bjerrehuus     51 |   250
  Henrik Qvortrup       29 |   147
  Amalie                27 |   150
  Nikita Klæstrup       25 |   137
  Janni Ree             25 |   191

Community 9 (Seed: Fie Laursen)
Size: 73 | Internal Strength: 1046
Density: 0.40 | Boundary Edges: 143
Top Members [Name | Degree | Total Co-mentions]:
  Fie Laursen           44 |   214
  Teitur Skoubo         31 |   152
  Lenny Pihl            24 |   127
  Anne Plejdrup         16 |    69
  Oliver Erngart        15 |    74

Community 10 (Seed: Martin)
Size: 70 | Internal Strength: 831
Density: 0.34 | Boundary Edges: 310
Top Members [Name | Degree | Total Co-mentions]:
  Kasper                41 |   187
  Caroline              37 |   169
  Emma                  28 |   120
  Trine                 28 |   162
  Anna                  23 |    88
</pre></div>
</div>
</div>
</div>
<p>We have added 3 measures to the communties:</p>
<ol class="arabic simple">
<li><p>Density: (Actual connections) / (Possible connections)</p></li>
<li><p>Internal Strength: Total weight of all connections between members within the community</p></li>
<li><p>Boundary Edges: Connections to outside partition</p></li>
</ol>
<p><strong>Community 1: Danish Royal Family</strong></p>
<ul class="simple">
<li><p>Highest internal strength (6801) and have a density of (1.25) which indicates alot of external connections. (The royal family is a huge network)</p></li>
</ul>
<p>Reflects extensive Danish media coverage of royal affairs</p>
<p><strong>Community 2: British Royal Family</strong></p>
<p><strong>Community 3: “Familien fra Bryggen”</strong></p>
<ul class="simple">
<li><p>Highest density (2.24). Its a closed network.</p></li>
</ul>
<p>Popular DR reality show about a Copenhagen family</p>
<p><strong>Community 4: Vild med dansk / Tv2</strong></p>
<p><strong>Community 5: TV-writers</strong></p>
<ul class="simple">
<li><p>Largest community with size 119 (very low density)</p></li>
</ul>
<p><strong>Community 6: Danish song writers</strong></p>
<p><strong>Community 7: Danish song writers”</strong></p>
<p><strong>Community 8: Danish models / celebrities</strong></p>
<p><strong>Community 9: SOME influencers</strong></p>
<p><strong>Community 10: Public Figures</strong></p>
<ul class="simple">
<li><p>Not possible to entirely identify due to missing last names.</p></li>
</ul>
<p>its possible to plot the graph but with colored partitions</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mcolors</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">netwulf</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nw</span>
<span class="c1"># Generate distinct colors</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_distinct_colors</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate n visually distinct colors&quot;&quot;&quot;</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;tab20&#39;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">mcolors</span><span class="o">.</span><span class="n">to_hex</span><span class="p">(</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

<span class="c1"># Prepare colors</span>
<span class="n">community_colors</span> <span class="o">=</span> <span class="n">get_distinct_colors</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_communities</span><span class="p">))</span>
<span class="n">default_color</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">]</span>  <span class="c1"># Normalized gray</span>

<span class="c1"># Assign colors and find biggest node in each community</span>
<span class="n">node_info</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">community_representatives</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">comm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_communities</span><span class="p">):</span>
    <span class="c1"># Get color in normalized RGBA</span>
    <span class="n">rgb</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">hex2color</span><span class="p">(</span><span class="n">community_colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">rgba</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>  <span class="c1"># [r, g, b, a] in range [0,1]</span>
    
    <span class="c1"># Find node with highest weighted degree in this community</span>
    <span class="n">members_with_degree</span> <span class="o">=</span> <span class="p">[(</span><span class="n">n</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;members&#39;</span><span class="p">]]</span>
    <span class="n">biggest_node</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">members_with_degree</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">community_representatives</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">biggest_node</span>
    
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;members&#39;</span><span class="p">]:</span>
        <span class="n">node_info</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">rgba</span><span class="p">,</span>
            <span class="s1">&#39;community&#39;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;is_representative&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="n">biggest_node</span><span class="p">)</span>
        <span class="p">}</span>

<span class="c1"># Handle unassigned nodes</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node_info</span><span class="p">:</span>
        <span class="n">node_info</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">default_color</span><span class="p">,</span>
            <span class="s1">&#39;community&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;is_representative&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>

<span class="c1"># Create visual attributes</span>
<span class="n">node_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">node_info</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">()]</span>
<span class="n">node_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">()]</span>

<span class="c1"># Layout</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">spring_layout</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="c1"># Prepare the network for visualization</span>
<span class="n">H_visual</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

<span class="c1"># Add node attributes</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">H_visual</span><span class="o">.</span><span class="n">nodes</span><span class="p">()):</span>
    <span class="n">hex_color</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">to_hex</span><span class="p">(</span><span class="n">node_info</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">])</span>
    <span class="n">H_visual</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
        <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">node_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">hex_color</span><span class="p">,</span>
        <span class="s1">&#39;community&#39;</span><span class="p">:</span> <span class="n">node_info</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;community&#39;</span><span class="p">],</span>
        <span class="s1">&#39;is_representative&#39;</span><span class="p">:</span> <span class="n">node_info</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;is_representative&#39;</span><span class="p">]</span>
    <span class="p">})</span>

    <span class="c1"># Special styling for representative nodes</span>
    <span class="k">if</span> <span class="n">node_info</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;is_representative&#39;</span><span class="p">]:</span>
        <span class="n">H_visual</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">node</span><span class="p">,</span>
            <span class="s1">&#39;label_color&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># White text</span>
            <span class="s1">&#39;label_stroke_color&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>   <span class="c1"># Black outline</span>
            <span class="s1">&#39;label_size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">node_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.2</span>  <span class="c1"># Slightly bigger</span>
        <span class="p">})</span>

<span class="c1"># Edge styling</span>
<span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">H_visual</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
    <span class="n">H_visual</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">weight</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">H_visual</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>


<span class="c1"># Visualize</span>
<span class="n">network</span><span class="p">,</span> <span class="n">config</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">H_visual</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">422</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_8356/2454207281.py:7: MatplotlibDeprecationWarning: The get_cmap function was deprecated in Matplotlib 3.7 and will be removed in 3.11. Use ``matplotlib.colormaps[name]`` or ``matplotlib.colormaps.get_cmap()`` or ``pyplot.get_cmap()`` instead.
  cmap = plt.cm.get_cmap(&#39;tab20&#39;, n)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image</span> <span class="o">=</span> <span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;pictures/graph2.png&#39;</span><span class="p">)</span>

<span class="c1"># Set a higher DPI and larger figsize</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>  <span class="c1"># Increase dpi for finer control</span>

<span class="c1"># Display image with manual scaling</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>  <span class="c1"># Stretch to fit (xmin, xmax, ymin, ymax)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/41475af1ffcde0b29eb432978cb1995d6a4f8d8b956d7281f683f6e70fc355c0.png" src="_images/41475af1ffcde0b29eb432978cb1995d6a4f8d8b956d7281f683f6e70fc355c0.png" />
</div>
</div>
<p>It’s very easy to see that our partition algorithm have found some communities.</p>
<p>Then we save the found communties in a dataframe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Collect community info into a list of dicts</span>
<span class="n">community_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">comm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_communities</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">members</span> <span class="o">=</span> <span class="p">[(</span><span class="n">n</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">graph</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;members&#39;</span><span class="p">]]</span>
    <span class="n">members_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">members</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]</span>

    <span class="n">density</span> <span class="o">=</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;internal_edges&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">comm</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">comm</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">1e-9</span><span class="p">)</span>
    <span class="n">boundary_edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">edge_boundary</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;members&#39;</span><span class="p">]))</span>

    <span class="n">top_members</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">members_sorted</span><span class="p">]</span>

    <span class="n">community_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s2">&quot;community_id&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
        <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">],</span>
        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
        <span class="s2">&quot;internal_edges&quot;</span><span class="p">:</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;internal_edges&#39;</span><span class="p">],</span>
        <span class="s2">&quot;density&quot;</span><span class="p">:</span> <span class="n">density</span><span class="p">,</span>
        <span class="s2">&quot;boundary_edges&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">boundary_edges</span><span class="p">),</span>
        <span class="s2">&quot;top_members&quot;</span><span class="p">:</span> <span class="n">top_members</span><span class="p">,</span>
        <span class="s2">&quot;all_members&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">comm</span><span class="p">[</span><span class="s1">&#39;members&#39;</span><span class="p">]),</span>
    <span class="p">})</span>

<span class="c1"># Create DataFrame</span>
<span class="n">communities_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">community_data</span><span class="p">)</span>

<span class="n">communities_df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="s2">&quot;dataset/top_communities.parquet&quot;</span><span class="p">)</span>

<span class="c1"># Display or save</span>
<span class="n">communities_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>community_id</th>
      <th>seed</th>
      <th>size</th>
      <th>internal_edges</th>
      <th>density</th>
      <th>boundary_edges</th>
      <th>top_members</th>
      <th>all_members</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Joachim</td>
      <td>104</td>
      <td>6801</td>
      <td>1.269791</td>
      <td>530</td>
      <td>[Dronning Margrethe, Joachim, Henrik, Frederik...</td>
      <td>[Nikolai, Frederik, Amber Petty, Jørgen Og, Er...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>Harry</td>
      <td>41</td>
      <td>1595</td>
      <td>1.945122</td>
      <td>182</td>
      <td>[Harry, Dronning Elizabeth, William, Philip, K...</td>
      <td>[Asbjørn Nielsen, Piers Morgan, Dronning Eliza...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>Geggo</td>
      <td>24</td>
      <td>676</td>
      <td>2.449275</td>
      <td>113</td>
      <td>[Geggo, Linse Kessler, Stephanie, Mikkel Kessl...</td>
      <td>[Didde, Cengiz Salvarli, Lulu, Linse Kessler, ...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>Silas Holst</td>
      <td>104</td>
      <td>2185</td>
      <td>0.407954</td>
      <td>337</td>
      <td>[Silas Holst, Mascha Vang, Christiane Schaumbu...</td>
      <td>[Branco, Lise Rønne, Jenna Bagge, Nicolaj Kope...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>Nikolaj Lie Kaas</td>
      <td>119</td>
      <td>2187</td>
      <td>0.311494</td>
      <td>379</td>
      <td>[Nikolaj Lie Kaas, Trine Dyrholm, Mads Mikkels...</td>
      <td>[Jussi Adler Olsen, Anders W. Berthelsen, Mikk...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>6</td>
      <td>Christopher</td>
      <td>95</td>
      <td>1730</td>
      <td>0.387458</td>
      <td>317</td>
      <td>[Christopher, Medina, Alexander, Christian Kjæ...</td>
      <td>[Walid Bechara, Frederik Bagger, Tessa Franck,...</td>
    </tr>
    <tr>
      <th>6</th>
      <td>7</td>
      <td>Thomas Helmig</td>
      <td>12</td>
      <td>217</td>
      <td>3.287879</td>
      <td>17</td>
      <td>[Thomas Helmig, Renée Toft Simonsen, Hugo Helm...</td>
      <td>[Søs Fenger, Renée Toft Simonsen, Hugo Helmig,...</td>
    </tr>
    <tr>
      <th>7</th>
      <td>8</td>
      <td>Oliver Bjerrehuus</td>
      <td>81</td>
      <td>1207</td>
      <td>0.372531</td>
      <td>280</td>
      <td>[Oliver Bjerrehuus, Henrik Qvortrup, Amalie, N...</td>
      <td>[Oliver Bjerrehuus, Michael Schøt, Michael Bun...</td>
    </tr>
    <tr>
      <th>8</th>
      <td>9</td>
      <td>Fie Laursen</td>
      <td>73</td>
      <td>1046</td>
      <td>0.398021</td>
      <td>143</td>
      <td>[Fie Laursen, Teitur Skoubo, Lenny Pihl, Anne ...</td>
      <td>[Faustix, Mio, Viggo, Ralf Christensen, Lai Yd...</td>
    </tr>
    <tr>
      <th>9</th>
      <td>10</td>
      <td>Martin</td>
      <td>70</td>
      <td>831</td>
      <td>0.344099</td>
      <td>310</td>
      <td>[Kasper, Caroline, Emma, Trine, Anna]</td>
      <td>[Rosa, Preben Kristensen, Rasmus, Christian De...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can also calculate the overall modularity for each community and how much they contribute to the overall moduluarity of the graph</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">calculate_modularity</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">communities</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate modularity for each community and total&quot;&quot;&quot;</span>
    <span class="n">total_weight</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">)</span>
    <span class="n">Q_total</span> <span class="o">=</span> <span class="mi">0</span>
    

    <span class="k">for</span> <span class="n">comm</span> <span class="ow">in</span> <span class="n">communities</span><span class="p">:</span>
        <span class="n">members</span> <span class="o">=</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;members&#39;</span><span class="p">]</span>
        <span class="c1"># Internal edge weight</span>
        <span class="n">l_c</span> <span class="o">=</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;internal_edges&#39;</span><span class="p">]</span>
        <span class="c1"># Total degree of community members</span>
        <span class="n">d_c</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">members</span><span class="p">)</span>
        
        <span class="c1"># Community&#39;s modularity contribution</span>
        <span class="n">Q_comm</span> <span class="o">=</span> <span class="p">(</span><span class="n">l_c</span><span class="o">/</span><span class="n">total_weight</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">d_c</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">total_weight</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;modularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q_comm</span>
        <span class="n">Q_total</span> <span class="o">+=</span> <span class="n">Q_comm</span>
        
    <span class="k">return</span> <span class="n">Q_total</span>

<span class="c1"># Add to your analysis</span>
<span class="n">total_modularity</span> <span class="o">=</span> <span class="n">calculate_modularity</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">top_communities</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total Network Modularity: </span><span class="si">{</span><span class="n">total_modularity</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">comm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_communities</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Community </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> Modularity: </span><span class="si">{</span><span class="n">comm</span><span class="p">[</span><span class="s1">&#39;modularity&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total Network Modularity: 0.350
Community 1 Modularity: 0.117
Community 2 Modularity: 0.032
Community 3 Modularity: 0.014
Community 4 Modularity: 0.043
Community 5 Modularity: 0.043
Community 6 Modularity: 0.034
Community 7 Modularity: 0.005
Community 8 Modularity: 0.024
Community 9 Modularity: 0.022
Community 10 Modularity: 0.017
</pre></div>
</div>
</div>
</div>
<p>Reading of the total network modularity, our graph has a non-random clustering, but communities aren’t perfectly isolated from the rest. This can also be seen on the community “boundary_edges” where we see it has alot of spillover to other communities. (or just be observed on the picture)</p>
</section>
</section>
<hr class="docutils" />
<section id="language-analysis-using-nlp-and-tf-idf">
<h2>🔎 Language Analysis (Using NLP and TF-IDF)<a class="headerlink" href="#language-analysis-using-nlp-and-tf-idf" title="Link to this heading">#</a></h2>
<p>Now we are interested in doing a language analysis of the articles and communities. To achieve this, we will use both the NLP results we have gathered earlier, and techniques such as TF and TF-IDF.</p>
<p><strong>Term Frequency (TF)</strong>
Measures how frequently a term appears in a document relative to its length.<br />
<strong>Formula</strong>:<br />
$<span class="math notranslate nohighlight">\( \text{TF}(t,d) = \frac{\text{Number of times term } t \text{ appears in document } d}{\text{Total number of terms in document } d} \)</span>$</p>
<p>Example: In a 1000-word article where “kongehus” appears 15 times:<br />
<code class="docutils literal notranslate"><span class="pre">TF(&quot;kongehus&quot;,</span> <span class="pre">article)</span> <span class="pre">=</span> <span class="pre">15/1000</span> <span class="pre">=</span> <span class="pre">0.015</span></code></p>
<p><strong>Term Frequency-Inverse Document Frequency (TF-IDF)</strong>
Measures how important a term is to a document in a collection, balancing:</p>
<ul class="simple">
<li><p>Frequency in document (TF)</p></li>
<li><p>Rarity across corpus (IDF)</p></li>
</ul>
<p><strong>Formulas</strong>:<br />
$<span class="math notranslate nohighlight">\( \text{TF-IDF}(t,d,D) = \text{TF}(t,d) \times \text{IDF}(t,D) \)</span><span class="math notranslate nohighlight">\(  
\)</span><span class="math notranslate nohighlight">\( \text{IDF}(t,D) = \log\left(\frac{\text{Total number of documents } |D|}{\text{Number of documents containing term } t}\right) \)</span>$</p>
<p>Example: If “kongehus” appears in 50 of 10,000 documents:<br />
<code class="docutils literal notranslate"><span class="pre">IDF(&quot;kongehus&quot;)</span> <span class="pre">=</span> <span class="pre">log(10000/50)</span> <span class="pre">≈</span> <span class="pre">5.30</span></code><br />
<code class="docutils literal notranslate"><span class="pre">TF-IDF</span> <span class="pre">=</span> <span class="pre">0.015</span> <span class="pre">*</span> <span class="pre">5.30</span> <span class="pre">≈</span> <span class="pre">0.0795</span></code></p>
<p><strong>Unique TF</strong>
Is just taking the largest TF weighted words, and making sure its unique to the words in the community (i.e finding unique frequently used words for men and women)</p>
<p>Application to Community Analysis
We will use these metrics to:</p>
<hr class="docutils" />
<ul class="simple">
<li><p><strong>TF-IDF</strong> Terms that best describe the gender in the community</p></li>
<li><p><strong>TF</strong> Terms that are frequently used to describe the gender in the community</p></li>
<li><p><strong>TF-Unique</strong> Terms that are uniquely used to describe the gender in the community</p></li>
</ul>
<section id="community-analysis">
<h3>Community Analysis<a class="headerlink" href="#community-analysis" title="Link to this heading">#</a></h3>
<section id="gendered-wording-analysis-using-tf-idf">
<h4>Gendered wording analysis using TF-IDF<a class="headerlink" href="#gendered-wording-analysis-using-tf-idf" title="Link to this heading">#</a></h4>
<p>We will use a wordcloud to construct an easy overview of the TF-IDF and TF. We will also take the top N = 15 unique TF weighted words for each community. We will also make sure to seppereate the words for each gender in each community.</p>
<p>The algorithm words the following way:</p>
<ul class="simple">
<li><p>First it cleans the text and removes simmilar words using sequence mathcer with threshold at 0.80.</p></li>
<li><p>Then for each community, get all the person_descriptions from members of the community</p></li>
<li><p>Per community</p>
<ul>
<li><p>Sepperate by men/female</p></li>
<li><p>Perform TF-IDF of terms from each sepperation. (return top 15)</p></li>
<li><p>Perform unique TF (returns words appearing in only one of the sepperations)</p></li>
</ul>
</li>
<li><p>Plot the words found in a sepperated wordcloud.</p></li>
</ul>
<p>Row one is community 1.
Row two is community 2. and so on…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">BOLD_FONT_PATH</span> <span class="o">=</span> <span class="s2">&quot;/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf&quot;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">BOLD_FONT_PATH</span><span class="p">):</span>
    <span class="n">BOLD_FONT_PATH</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">BACKGROUND_COLOR</span> <span class="o">=</span> <span class="s1">&#39;#6e6e6e&#39;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">preprocess_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean and normalize Danish/English text.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^\wæøåÆØÅ-]&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">word</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">filter_similar_words</span><span class="p">(</span><span class="n">word_dict</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.80</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter out similar words using fuzzy matching.&quot;&quot;&quot;</span>
    <span class="n">filtered</span><span class="p">,</span> <span class="n">seen</span> <span class="o">=</span> <span class="p">{},</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">word_dict</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">word_dict</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">SequenceMatcher</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">threshold</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        <span class="n">filtered</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">word_dict</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">filtered</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_community_documents</span><span class="p">(</span><span class="n">communities</span><span class="p">,</span> <span class="n">names_df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract and clean all member descriptions per community.&quot;&quot;&quot;</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">comm_id</span><span class="p">,</span> <span class="n">comm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">communities</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;members&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="n">names_df</span><span class="p">[</span><span class="s1">&#39;canonical_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">member</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">descs</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;person_descriptions&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">descs</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">descs</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">continue</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">all_words</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">desc_list</span> <span class="ow">in</span> <span class="n">descs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">desc_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">clean</span> <span class="o">=</span> <span class="n">preprocess_text</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desc_list</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">clean</span><span class="p">:</span>
                                <span class="n">all_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clean</span><span class="p">)</span>
                    <span class="n">docs</span><span class="p">[</span><span class="n">comm_id</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_words</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing </span><span class="si">{</span><span class="n">member</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">docs</span>


<span class="k">def</span><span class="w"> </span><span class="nf">make_wordcloud</span><span class="p">(</span><span class="n">word_dict</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">BACKGROUND_COLOR</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">word_dict</span><span class="p">:</span>
        <span class="n">wc</span> <span class="o">=</span> <span class="n">WordCloud</span><span class="p">(</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">background_color</span><span class="o">=</span><span class="n">BACKGROUND_COLOR</span><span class="p">,</span>
            <span class="n">colormap</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">contour_width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">contour_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
            <span class="n">font_path</span><span class="o">=</span><span class="n">BOLD_FONT_PATH</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">min_font_size</span><span class="o">=</span><span class="mi">14</span>
        <span class="p">)</span><span class="o">.</span><span class="n">generate_from_frequencies</span><span class="p">(</span><span class="n">word_dict</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;No Data&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">analyze_communities</span><span class="p">(</span><span class="n">top_communities</span><span class="p">,</span> <span class="n">names_df</span><span class="p">):</span>
    <span class="n">community_docs</span> <span class="o">=</span> <span class="n">get_community_documents</span><span class="p">(</span><span class="n">top_communities</span><span class="p">,</span> <span class="n">names_df</span><span class="p">)</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">community_docs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">community_docs</span><span class="p">))</span> <span class="k">if</span> <span class="n">community_docs</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span>
        <span class="n">token_pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\b[^\d\W]{3,}\b&#39;</span><span class="p">,</span> <span class="n">min_df</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_df</span><span class="o">=</span><span class="mf">0.9</span>
    <span class="p">)</span>
    <span class="n">tfidf_matrix</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
    <span class="n">terms</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
    <span class="n">gender_group_occurrences</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

    <span class="n">num_communities</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_communities</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_communities</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">num_communities</span> <span class="o">*</span> <span class="mi">6</span><span class="p">),</span>
                             <span class="n">facecolor</span><span class="o">=</span><span class="n">BACKGROUND_COLOR</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Community WordClouds by Gender&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">row_idx</span><span class="p">,</span> <span class="n">comm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_communities</span><span class="p">):</span>
        <span class="n">comm_id</span> <span class="o">=</span> <span class="n">row_idx</span>
        <span class="n">male_words</span><span class="p">,</span> <span class="n">female_words</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;members&#39;</span><span class="p">]:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="n">names_df</span><span class="p">[</span><span class="s1">&#39;canonical_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">member</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">gender</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gender&#39;</span><span class="p">)</span>
            <span class="n">descs</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;person_descriptions&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">descs</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">descs</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">all_text</span> <span class="o">=</span> <span class="p">[</span><span class="n">preprocess_text</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desc_list</span><span class="p">))</span> 
                            <span class="k">for</span> <span class="n">desc_list</span> <span class="ow">in</span> <span class="n">descs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">desc_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">)]</span>
                <span class="n">joined</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_text</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">gender</span> <span class="o">==</span> <span class="s2">&quot;male&quot;</span><span class="p">:</span>
                    <span class="n">male_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joined</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">gender</span> <span class="o">==</span> <span class="s2">&quot;female&quot;</span><span class="p">:</span>
                    <span class="n">female_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joined</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col_offset</span><span class="p">,</span> <span class="n">group_words</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">male_words</span><span class="p">,</span> <span class="s2">&quot;Blues&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">female_words</span><span class="p">,</span> <span class="s2">&quot;Reds&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span>
        <span class="p">]:</span>
            <span class="n">full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_words</span><span class="p">)</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">full_text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

            <span class="n">gender_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">comm_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
                <span class="n">gender_group_occurrences</span><span class="p">[</span><span class="n">word</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gender_key</span><span class="p">)</span>

            <span class="c1"># TF-IDF</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">subgroup_vec</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_words</span><span class="p">)])</span>
                <span class="n">tfidf_scores</span> <span class="o">=</span> <span class="n">subgroup_vec</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">tfidf_words</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">terms</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span> <span class="n">tfidf_scores</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">tfidf_scores</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">tfidf_scores</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">}</span>
                <span class="n">tfidf_words</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">filter_similar_words</span><span class="p">(</span><span class="n">tfidf_words</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())[:</span><span class="mi">15</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">tfidf_words</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Frequency</span>
            <span class="n">freq_words</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">filter_similar_words</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())[:</span><span class="mi">15</span><span class="p">])</span>

            <span class="c1"># Unique word scaling</span>
            <span class="n">unique</span> <span class="o">=</span> <span class="p">{</span><span class="n">w</span><span class="p">:</span> <span class="n">counter</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">counter</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gender_group_occurrences</span><span class="p">[</span><span class="n">w</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">}</span>
            <span class="n">unique</span> <span class="o">=</span> <span class="n">filter_similar_words</span><span class="p">(</span><span class="n">unique</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">min_f</span><span class="p">,</span> <span class="n">max_f</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                <span class="n">scaled</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">w</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">min_f</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_f</span> <span class="o">-</span> <span class="n">min_f</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">90</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">unique</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">unique_words</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">scaled</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">15</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unique_words</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">word_dict</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span>
                <span class="p">(</span><span class="n">tfidf_words</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2"> TF-IDF&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">freq_words</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2"> Freq&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">unique_words</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2"> Unique TF&quot;</span><span class="p">)</span>
            <span class="p">]):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_offset</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="k">if</span> <span class="n">num_communities</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">axes</span><span class="p">[</span><span class="n">col_offset</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">make_wordcloud</span><span class="p">(</span><span class="n">word_dict</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;da-wordcloud.pdf&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;da-wordcloud.png&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># Example call — make sure these variables are defined</span>
<span class="n">analyze_communities</span><span class="p">(</span><span class="n">top_communities</span><span class="p">,</span> <span class="n">names_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/773f4890583582e5e44403982e466eac18cbbff9616d458883b709aa9d6cd772.png" src="_images/773f4890583582e5e44403982e466eac18cbbff9616d458883b709aa9d6cd772.png" />
</div>
</div>
<p>English version using the Google translate module:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">deep_translator</span><span class="w"> </span><span class="kn">import</span> <span class="n">GoogleTranslator</span>


<span class="n">translation_cache</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">translate_words</span><span class="p">(</span><span class="n">word_dict</span><span class="p">,</span> <span class="n">source_lang</span><span class="o">=</span><span class="s1">&#39;da&#39;</span><span class="p">,</span> <span class="n">target_lang</span><span class="o">=</span><span class="s1">&#39;en&#39;</span><span class="p">):</span>
    <span class="n">translator</span> <span class="o">=</span> <span class="n">GoogleTranslator</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source_lang</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target_lang</span><span class="p">)</span>
    <span class="n">translated</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">word_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">translation_cache</span><span class="p">:</span>
            <span class="n">translated_word</span> <span class="o">=</span> <span class="n">translation_cache</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">translated_word</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                <span class="n">translation_cache</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">translated_word</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">translated_word</span> <span class="o">=</span> <span class="n">word</span>  <span class="c1"># fallback</span>
                <span class="n">translation_cache</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">word</span>
        <span class="n">translated</span><span class="p">[</span><span class="n">translated_word</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>
    <span class="k">return</span> <span class="n">translated</span>

<span class="k">def</span><span class="w"> </span><span class="nf">preprocess_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^\wæøåÆØÅ-]&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">word</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">filter_similar_words</span><span class="p">(</span><span class="n">word_dict</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.80</span><span class="p">):</span>
    <span class="n">filtered</span><span class="p">,</span> <span class="n">seen</span> <span class="o">=</span> <span class="p">{},</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">word_dict</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">word_dict</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">SequenceMatcher</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">threshold</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        <span class="n">filtered</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">word_dict</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">filtered</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_community_documents</span><span class="p">(</span><span class="n">communities</span><span class="p">,</span> <span class="n">names_df</span><span class="p">):</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">comm_id</span><span class="p">,</span> <span class="n">comm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">communities</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;members&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="n">names_df</span><span class="p">[</span><span class="s1">&#39;canonical_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">member</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">descs</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;person_descriptions&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">descs</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">descs</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">all_words</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">desc_list</span> <span class="ow">in</span> <span class="n">descs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">desc_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">clean</span> <span class="o">=</span> <span class="n">preprocess_text</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desc_list</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">clean</span><span class="p">:</span>
                                <span class="n">all_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clean</span><span class="p">)</span>
                    <span class="n">docs</span><span class="p">[</span><span class="n">comm_id</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_words</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing </span><span class="si">{</span><span class="n">member</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">docs</span>


<span class="k">def</span><span class="w"> </span><span class="nf">make_wordcloud</span><span class="p">(</span><span class="n">word_dict</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">BACKGROUND_COLOR</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">word_dict</span><span class="p">:</span>
        <span class="n">wc</span> <span class="o">=</span> <span class="n">WordCloud</span><span class="p">(</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">background_color</span><span class="o">=</span><span class="n">BACKGROUND_COLOR</span><span class="p">,</span>
            <span class="n">colormap</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">contour_width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">contour_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
            <span class="n">font_path</span><span class="o">=</span><span class="n">BOLD_FONT_PATH</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">min_font_size</span><span class="o">=</span><span class="mi">14</span>
        <span class="p">)</span><span class="o">.</span><span class="n">generate_from_frequencies</span><span class="p">(</span><span class="n">word_dict</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;No Data&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">analyze_communities</span><span class="p">(</span><span class="n">top_communities</span><span class="p">,</span> <span class="n">names_df</span><span class="p">):</span>
    <span class="n">community_docs</span> <span class="o">=</span> <span class="n">get_community_documents</span><span class="p">(</span><span class="n">top_communities</span><span class="p">,</span> <span class="n">names_df</span><span class="p">)</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">community_docs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">community_docs</span><span class="p">))</span> <span class="k">if</span> <span class="n">community_docs</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span>
        <span class="n">token_pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\b[^\d\W]{3,}\b&#39;</span><span class="p">,</span> <span class="n">min_df</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_df</span><span class="o">=</span><span class="mf">0.9</span>
    <span class="p">)</span>
    <span class="n">tfidf_matrix</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
    <span class="n">terms</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
    <span class="n">gender_group_occurrences</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

    <span class="n">num_communities</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_communities</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_communities</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">num_communities</span> <span class="o">*</span> <span class="mi">6</span><span class="p">),</span>
                             <span class="n">facecolor</span><span class="o">=</span><span class="n">BACKGROUND_COLOR</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Community WordClouds by Gender&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">row_idx</span><span class="p">,</span> <span class="n">comm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_communities</span><span class="p">):</span>
        <span class="n">comm_id</span> <span class="o">=</span> <span class="n">row_idx</span>
        <span class="n">male_words</span><span class="p">,</span> <span class="n">female_words</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;members&#39;</span><span class="p">]:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="n">names_df</span><span class="p">[</span><span class="s1">&#39;canonical_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">member</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">gender</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gender&#39;</span><span class="p">)</span>
            <span class="n">descs</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;person_descriptions&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">descs</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">descs</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">all_text</span> <span class="o">=</span> <span class="p">[</span><span class="n">preprocess_text</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desc_list</span><span class="p">))</span> 
                            <span class="k">for</span> <span class="n">desc_list</span> <span class="ow">in</span> <span class="n">descs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">desc_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">)]</span>
                <span class="n">joined</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_text</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">gender</span> <span class="o">==</span> <span class="s2">&quot;male&quot;</span><span class="p">:</span>
                    <span class="n">male_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joined</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">gender</span> <span class="o">==</span> <span class="s2">&quot;female&quot;</span><span class="p">:</span>
                    <span class="n">female_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joined</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col_offset</span><span class="p">,</span> <span class="n">group_words</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">male_words</span><span class="p">,</span> <span class="s2">&quot;Blues&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">female_words</span><span class="p">,</span> <span class="s2">&quot;Reds&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span>
        <span class="p">]:</span>
            <span class="n">full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_words</span><span class="p">)</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">full_text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

            <span class="n">gender_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">comm_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
                <span class="n">gender_group_occurrences</span><span class="p">[</span><span class="n">word</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gender_key</span><span class="p">)</span>

            <span class="c1"># TF-IDF</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">subgroup_vec</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_words</span><span class="p">)])</span>
                <span class="n">tfidf_scores</span> <span class="o">=</span> <span class="n">subgroup_vec</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">tfidf_words</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">terms</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span> <span class="n">tfidf_scores</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">tfidf_scores</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">tfidf_scores</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">}</span>
                <span class="n">tfidf_words</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">filter_similar_words</span><span class="p">(</span><span class="n">tfidf_words</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())[:</span><span class="mi">15</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">tfidf_words</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Frequency</span>
            <span class="n">freq_words</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">filter_similar_words</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())[:</span><span class="mi">15</span><span class="p">])</span>

            <span class="c1"># Unique word scaling</span>
            <span class="n">unique</span> <span class="o">=</span> <span class="p">{</span><span class="n">w</span><span class="p">:</span> <span class="n">counter</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">counter</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gender_group_occurrences</span><span class="p">[</span><span class="n">w</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">}</span>
            <span class="n">unique</span> <span class="o">=</span> <span class="n">filter_similar_words</span><span class="p">(</span><span class="n">unique</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">min_f</span><span class="p">,</span> <span class="n">max_f</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                <span class="n">scaled</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">w</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">min_f</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_f</span> <span class="o">-</span> <span class="n">min_f</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">90</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">unique</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">unique_words</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">scaled</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">15</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unique_words</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">word_dict</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span>
                <span class="p">(</span><span class="n">tfidf_words</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2"> TF-IDF&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">freq_words</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2"> Freq&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">unique_words</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2"> Unique TF&quot;</span><span class="p">)</span>
            <span class="p">]):</span>
                <span class="n">translated_dict</span> <span class="o">=</span> <span class="n">translate_words</span><span class="p">(</span><span class="n">word_dict</span><span class="p">)</span>  <span class="c1"># Efficient translation with cache</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_offset</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="k">if</span> <span class="n">num_communities</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">axes</span><span class="p">[</span><span class="n">col_offset</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">make_wordcloud</span><span class="p">(</span><span class="n">translated_dict</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;en-wordcloud.pdf&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;en-wordcloud.png&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">analyze_communities</span><span class="p">(</span><span class="n">top_communities</span><span class="p">,</span> <span class="n">names_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6677ee6974791057333eeef6eb452f4c4a7f5c0e1ebfb3176227db37efd3dd2a.png" src="_images/6677ee6974791057333eeef6eb452f4c4a7f5c0e1ebfb3176227db37efd3dd2a.png" />
</div>
</div>
<p><strong>Plotting of the unique words only</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">analyze_communities</span><span class="p">(</span><span class="n">top_communities</span><span class="p">,</span> <span class="n">names_df</span><span class="p">):</span>
    <span class="n">community_docs</span> <span class="o">=</span> <span class="n">get_community_documents</span><span class="p">(</span><span class="n">top_communities</span><span class="p">,</span> <span class="n">names_df</span><span class="p">)</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">community_docs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">community_docs</span><span class="p">))</span> <span class="k">if</span> <span class="n">community_docs</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span>
        <span class="n">token_pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\b[^\d\W]{3,}\b&#39;</span><span class="p">,</span> <span class="n">min_df</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_df</span><span class="o">=</span><span class="mf">0.9</span>
    <span class="p">)</span>
    <span class="n">tfidf_matrix</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
    <span class="n">terms</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
    <span class="n">gender_group_occurrences</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

    <span class="n">num_communities</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_communities</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_communities</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">num_communities</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span>
                             <span class="n">facecolor</span><span class="o">=</span><span class="n">BACKGROUND_COLOR</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Unique WordClouds by Gender (Translated)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">row_idx</span><span class="p">,</span> <span class="n">comm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_communities</span><span class="p">):</span>
        <span class="n">comm_id</span> <span class="o">=</span> <span class="n">row_idx</span>
        <span class="n">male_words</span><span class="p">,</span> <span class="n">female_words</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;members&#39;</span><span class="p">]:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="n">names_df</span><span class="p">[</span><span class="s1">&#39;canonical_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">member</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">gender</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gender&#39;</span><span class="p">)</span>
            <span class="n">descs</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;person_descriptions&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">descs</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">descs</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">all_text</span> <span class="o">=</span> <span class="p">[</span><span class="n">preprocess_text</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desc_list</span><span class="p">))</span> 
                            <span class="k">for</span> <span class="n">desc_list</span> <span class="ow">in</span> <span class="n">descs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">desc_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">)]</span>
                <span class="n">joined</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_text</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">gender</span> <span class="o">==</span> <span class="s2">&quot;male&quot;</span><span class="p">:</span>
                    <span class="n">male_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joined</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">gender</span> <span class="o">==</span> <span class="s2">&quot;female&quot;</span><span class="p">:</span>
                    <span class="n">female_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joined</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col_offset</span><span class="p">,</span> <span class="n">group_words</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">male_words</span><span class="p">,</span> <span class="s2">&quot;Blues&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">female_words</span><span class="p">,</span> <span class="s2">&quot;Reds&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span>
        <span class="p">]:</span>
            <span class="n">full_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_words</span><span class="p">)</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">full_text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

            <span class="n">gender_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">comm_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
                <span class="n">gender_group_occurrences</span><span class="p">[</span><span class="n">word</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gender_key</span><span class="p">)</span>

            <span class="c1"># Unique word scaling</span>
            <span class="n">unique</span> <span class="o">=</span> <span class="p">{</span><span class="n">w</span><span class="p">:</span> <span class="n">counter</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">counter</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gender_group_occurrences</span><span class="p">[</span><span class="n">w</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">}</span>
            <span class="n">unique</span> <span class="o">=</span> <span class="n">filter_similar_words</span><span class="p">(</span><span class="n">unique</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">min_f</span><span class="p">,</span> <span class="n">max_f</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                <span class="n">scaled</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">w</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">min_f</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_f</span> <span class="o">-</span> <span class="n">min_f</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">90</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">unique</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">unique_words</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">scaled</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">15</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unique_words</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">translated_dict</span> <span class="o">=</span> <span class="n">translate_words</span><span class="p">(</span><span class="n">unique_words</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_offset</span><span class="p">]</span> <span class="k">if</span> <span class="n">num_communities</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">axes</span><span class="p">[</span><span class="n">col_offset</span><span class="p">]</span>
            <span class="n">make_wordcloud</span><span class="p">(</span><span class="n">translated_dict</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2"> Unique TF&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;en-wordcloud-unique.pdf&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;en-wordcloud-unique.png&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">analyze_communities</span><span class="p">(</span><span class="n">top_communities</span><span class="p">,</span> <span class="n">names_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/10b9689df16204d5b92f830da8b707c4ee9232c342e9c6b1f9ab0ab545a81b77.png" src="_images/10b9689df16204d5b92f830da8b707c4ee9232c342e9c6b1f9ab0ab545a81b77.png" />
</div>
</div>
<p>Here its possible to see a clear gender-specific langauge tendency.</p>
</section>
<section id="sentiment-analysis-of-communtiies">
<h4>Sentiment analysis of communtiies<a class="headerlink" href="#sentiment-analysis-of-communtiies" title="Link to this heading">#</a></h4>
<p>We are interested in creating a sentiment avg of each community. Both overall and gendered.</p>
<p>It works by doing the following:</p>
<ul class="simple">
<li><p>For each all_members go to names_df and use their canonical_name to search for article_ids</p></li>
<li><p>For each article id in each member.. Check for each article if the article is about them only, by looking at names_df[‘aliaes] in ner_clusters, if the members aliases dominantes the ner_cluster, the article is about them. Use the article:</p></li>
<li><p>Use the sentiment_label “negative = 0” “positive = 1” and find average sentiment_label of the community. Also make a gendered avg where sentiment for gender = female, and gender = male.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">article_about_member</span><span class="p">(</span><span class="n">article_row</span><span class="p">,</span> <span class="n">aliases</span><span class="p">):</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">article_row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ner_clusters&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">clusters</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="c1"># Count how many times each alias appears in the article</span>
    <span class="n">alias_count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">([</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">clusters</span> <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">alias_count</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="c1"># Find the alias with the highest frequency</span>
    <span class="n">max_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">alias_count</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="c1"># Get all aliases that have the max count (for ties)</span>
    <span class="n">most_frequent_aliases</span> <span class="o">=</span> <span class="p">[</span><span class="n">alias</span> <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">alias_count</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="n">max_count</span><span class="p">]</span>
    
    <span class="c1"># Return the most frequent aliases in the article</span>
    <span class="k">return</span> <span class="n">most_frequent_aliases</span>

<span class="c1"># Prepare data storage with community info</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">comm</span> <span class="ow">in</span> <span class="n">communities_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">members</span> <span class="o">=</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;all_members&#39;</span><span class="p">]</span>
    <span class="n">all_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">male_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">female_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">comm_id</span> <span class="o">=</span> <span class="n">comm</span><span class="p">[</span><span class="s1">&#39;community_id&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="n">names_df</span><span class="p">[</span><span class="s1">&#39;canonical_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">member</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">gender</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span>
        <span class="n">aliases</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;aliases&#39;</span><span class="p">]</span>
        <span class="n">art_ids</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;article_ids&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">art_ids</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">art_ids</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">art_ids</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="n">subset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;article_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">art_ids</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Update article filtering logic to handle multiple people if there&#39;s a tie</span>
        <span class="n">valid_articles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">subset</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">involved_people</span> <span class="o">=</span> <span class="n">article_about_member</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">aliases</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">involved_people</span><span class="p">:</span>  <span class="c1"># If the result is not False</span>
                <span class="c1"># Get sentiment score from sentiment_label and sentiment_score</span>
                <span class="n">sentiment_score</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;sentiment_score&#39;</span><span class="p">]</span>  <span class="c1"># Assuming this is a float between 0 and 1</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;sentiment_label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span>
                    <span class="n">weighted_sentiment</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">sentiment_score</span>  <span class="c1"># Negative sentiment should be negative</span>
                <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;sentiment_label&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;neutral&quot;</span><span class="p">:</span>
                    <span class="n">weighted_sentiment</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">weighted_sentiment</span> <span class="o">=</span> <span class="n">sentiment_score</span>  <span class="c1"># Positive sentiment is positive</span>
                
                <span class="c1"># Add the weighted sentiment to the lists of scores</span>
                <span class="n">all_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weighted_sentiment</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">gender</span> <span class="o">==</span> <span class="s1">&#39;male&#39;</span><span class="p">:</span>
                    <span class="n">male_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weighted_sentiment</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">gender</span> <span class="o">==</span> <span class="s1">&#39;female&#39;</span><span class="p">:</span>
                    <span class="n">female_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weighted_sentiment</span><span class="p">)</span>
                
                <span class="n">valid_articles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">subset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">valid_articles</span><span class="p">)</span>  <span class="c1"># Create a new DataFrame with only valid articles</span>

    <span class="c1"># Calculate weighted averages and dominance</span>
    <span class="n">avg_overall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_scores</span><span class="p">)</span> <span class="k">if</span> <span class="n">all_scores</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">avg_male</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">male_scores</span><span class="p">)</span> <span class="k">if</span> <span class="n">male_scores</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">avg_female</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">female_scores</span><span class="p">)</span> <span class="k">if</span> <span class="n">female_scores</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># Determine which gender is more negative (has lower score)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">avg_male</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">avg_female</span><span class="p">):</span>
        <span class="n">dominance</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
    <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">avg_male</span> <span class="o">-</span> <span class="n">avg_female</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>  <span class="c1"># 5% threshold for tie</span>
        <span class="n">dominance</span> <span class="o">=</span> <span class="s1">&#39;tie&#39;</span>
    <span class="k">elif</span> <span class="n">avg_male</span> <span class="o">&lt;</span> <span class="n">avg_female</span><span class="p">:</span>  <span class="c1"># Male is more negative</span>
        <span class="n">dominance</span> <span class="o">=</span> <span class="s1">&#39;male&#39;</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Female is more negative</span>
        <span class="n">dominance</span> <span class="o">=</span> <span class="s1">&#39;female&#39;</span>
    
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;comm_id&#39;</span><span class="p">:</span> <span class="n">comm_id</span><span class="p">,</span>
        <span class="s1">&#39;overall&#39;</span><span class="p">:</span> <span class="n">avg_overall</span><span class="p">,</span>
        <span class="s1">&#39;male&#39;</span><span class="p">:</span> <span class="n">avg_male</span><span class="p">,</span>
        <span class="s1">&#39;female&#39;</span><span class="p">:</span> <span class="n">avg_female</span><span class="p">,</span>
        <span class="s1">&#39;dominance&#39;</span><span class="p">:</span> <span class="n">dominance</span>
    <span class="p">})</span>

<span class="c1"># Sort by most negative overall first</span>
<span class="n">results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Create single plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.25</span>

<span class="c1"># Plot bars</span>
<span class="n">overall_bars</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                      <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Overall&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">male_bars</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;male&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                   <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Male&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">female_bars</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;female&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                     <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Female&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="c1"># Add dominance markers at the bottom of each group</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
    <span class="n">y_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.05</span>  <span class="c1"># Position below the bars</span>
    <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;dominance&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;male&#39;</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_pos</span><span class="p">,</span> <span class="s1">&#39;♂&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> 
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;dominance&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;female&#39;</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_pos</span><span class="p">,</span> <span class="s1">&#39;♀&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;dominance&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;tie&#39;</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_pos</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> 
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;comm_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Community ID (Sorted by Most Negative Overall)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sentiment (Negative=Lower, Positive=Higher)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Community Sentiment Analysis</span><span class="se">\n</span><span class="s1">(Markers show which gender has more negative content)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="c1">#plt.ylim(-0.1, 0.5)  # Extra space for dominance markers</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;community-sentiment-analysis.pdf&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ca64d21e242b3309ec926af3943e818689118dac57f70fe3ebfb8ec8f77d412b.png" src="_images/ca64d21e242b3309ec926af3943e818689118dac57f70fe3ebfb8ec8f77d412b.png" />
</div>
</div>
</section>
<section id="hatespeech-analysis-of-communtiies">
<h4>Hatespeech analysis of communtiies<a class="headerlink" href="#hatespeech-analysis-of-communtiies" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>


<span class="k">def</span><span class="w"> </span><span class="nf">article_about_memberNew</span><span class="p">(</span><span class="n">article_row</span><span class="p">,</span> <span class="n">aliases</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Improved article filtering using frequency analysis of NER clusters&quot;&quot;&quot;</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">article_row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ner_clusters&#39;</span><span class="p">,</span> <span class="p">[])</span>
    
    <span class="c1"># Handle string-encoded clusters</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">clusters</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="c1"># Count alias occurrences</span>
    <span class="n">alias_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">clusters</span> <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">alias_counter</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="c1"># Find maximum frequency and return most frequent aliases</span>
    <span class="n">max_freq</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">alias_counter</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">alias</span> <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">alias_counter</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="n">max_freq</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">analyze_community_sentiment</span><span class="p">(</span><span class="n">communities_df</span><span class="p">,</span> <span class="n">names_df</span><span class="p">,</span> <span class="n">article_df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main analysis function with integrated NER filtering&quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Process each community</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">comm_row</span> <span class="ow">in</span> <span class="n">communities_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">members</span> <span class="o">=</span> <span class="n">comm_row</span><span class="p">[</span><span class="s1">&#39;all_members&#39;</span><span class="p">]</span>
        <span class="n">all_sents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">male_sents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">female_sents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">comm_id</span> <span class="o">=</span> <span class="n">comm_row</span><span class="p">[</span><span class="s1">&#39;community_id&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
            <span class="c1"># Member matching</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="n">names_df</span><span class="p">[</span><span class="s1">&#39;canonical_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">member</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Extract member data</span>
            <span class="n">gender</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span>
            <span class="n">article_ids</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;article_ids&#39;</span><span class="p">]</span>
            <span class="n">aliases</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;aliases&#39;</span><span class="p">]</span>

            <span class="c1"># Convert string-encoded lists</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="n">article_ids</span><span class="p">,</span> <span class="n">aliases</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">field</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">field</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Filter relevant articles</span>
            <span class="n">df_se</span> <span class="o">=</span> <span class="n">article_df</span><span class="p">[</span><span class="n">article_df</span><span class="p">[</span><span class="s1">&#39;article_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">article_ids</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df_se</span> <span class="o">=</span> <span class="n">df_se</span><span class="p">[</span><span class="n">df_se</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">article_about_memberNew</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">aliases</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>

            <span class="c1"># Map hate speech labels</span>
            <span class="n">df_se</span><span class="p">[</span><span class="s1">&#39;hate_speech&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_se</span><span class="p">[</span><span class="s1">&#39;hate_speech&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">({</span>
                <span class="s1">&#39;not offensive&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> 
                <span class="s1">&#39;spam &amp; indhold&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;personangreb&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;sprogbrug&#39;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">})</span>

            <span class="c1"># Collect sentences</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">df_se</span><span class="p">[</span><span class="s1">&#39;hate_speech&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">all_sents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gender</span> <span class="o">==</span> <span class="s1">&#39;male&#39;</span><span class="p">:</span>
                <span class="n">male_sents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">gender</span> <span class="o">==</span> <span class="s1">&#39;female&#39;</span><span class="p">:</span>
                <span class="n">female_sents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># Calculate averages</span>
        <span class="n">avg_overall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_sents</span><span class="p">)</span> <span class="k">if</span> <span class="n">all_sents</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">avg_male</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">male_sents</span><span class="p">)</span> <span class="k">if</span> <span class="n">male_sents</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">avg_female</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">female_sents</span><span class="p">)</span> <span class="k">if</span> <span class="n">female_sents</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Determine dominance</span>
        <span class="n">dominance</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">avg_male</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">avg_female</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">avg_male</span> <span class="o">-</span> <span class="n">avg_female</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
                <span class="n">dominance</span> <span class="o">=</span> <span class="s1">&#39;tie&#39;</span>
            <span class="k">elif</span> <span class="n">avg_male</span> <span class="o">&lt;</span> <span class="n">avg_female</span><span class="p">:</span>
                <span class="n">dominance</span> <span class="o">=</span> <span class="s1">&#39;male&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dominance</span> <span class="o">=</span> <span class="s1">&#39;female&#39;</span>
        
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;comm_id&#39;</span><span class="p">:</span> <span class="n">comm_id</span><span class="p">,</span>
            <span class="s1">&#39;overall&#39;</span><span class="p">:</span> <span class="n">avg_overall</span><span class="p">,</span>
            <span class="s1">&#39;male&#39;</span><span class="p">:</span> <span class="n">avg_male</span><span class="p">,</span>
            <span class="s1">&#39;female&#39;</span><span class="p">:</span> <span class="n">avg_female</span><span class="p">,</span>
            <span class="s1">&#39;dominance&#39;</span><span class="p">:</span> <span class="n">dominance</span>
        <span class="p">})</span>

    <span class="c1"># Sort results by negativity</span>
    <span class="n">results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mf">0.25</span>

    <span class="c1"># Create bars</span>
    <span class="n">overall_bars</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Overall&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">male_bars</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;male&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                       <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Male&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">female_bars</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;female&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
                         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Female&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

    <span class="c1"># Add dominance markers</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="n">y_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.05</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;dominance&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;male&#39;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_pos</span><span class="p">,</span> <span class="s1">&#39;♂&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> 
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;dominance&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;female&#39;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_pos</span><span class="p">,</span> <span class="s1">&#39;♀&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;dominance&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;tie&#39;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_pos</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> 
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

    <span class="c1"># Finalize plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;comm_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Community ID (Sorted by Most Negative Overall)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Average Hate Speech (0=hate speech, 1=clean)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Community Sentiment Analysis&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;hate-speech-gender.pdf&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">analyze_community_sentiment</span><span class="p">(</span>
    <span class="n">communities_df</span><span class="o">=</span><span class="n">communities_df</span><span class="p">,</span>
    <span class="n">names_df</span><span class="o">=</span><span class="n">names_df</span><span class="p">,</span>
    <span class="n">article_df</span><span class="o">=</span><span class="n">df</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e191b4c76af5700a0b9ab4f9cf7932cf103a8c287e0fc5a2dcec9901515d9dba.png" src="_images/e191b4c76af5700a0b9ab4f9cf7932cf103a8c287e0fc5a2dcec9901515d9dba.png" />
</div>
</div>
<p>Genereally we see that women are more prone to hate-speech than men in theese communties</p>
</section>
<section id="emotion-distribution-of-communtiies">
<h4>Emotion distribution of communtiies<a class="headerlink" href="#emotion-distribution-of-communtiies" title="Link to this heading">#</a></h4>
<p>We have the following emotions, so by plotting each community over theese its possible to see if a gender dominates one of the categories.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;emotion&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;not offensive&quot;</span><span class="p">][</span><span class="s1">&#39;emotion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;foragt/modvilje&#39;, &#39;forventning/interrese&#39;, &#39;frygt/bekymret&#39;,
       &#39;glæde/sindsro&#39;, &#39;no emotion&#39;, &#39;sorg/trist&#39;, &#39;tillid/accept&#39;,
       &#39;overasket/målløs&#39;, &#39;vrede/irritation&#39;], dtype=object)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>  <span class="c1"># Added Counter</span>

<span class="k">def</span><span class="w"> </span><span class="nf">article_about_member</span><span class="p">(</span><span class="n">article_row</span><span class="p">,</span> <span class="n">aliases</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return most frequent aliases appearing in NER clusters&quot;&quot;&quot;</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">article_row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ner_clusters&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">clusters</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="c1"># Count alias frequencies</span>
    <span class="n">alias_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">clusters</span> <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">alias_counter</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="c1"># Find maximum frequency</span>
    <span class="n">max_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">alias_counter</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    
    <span class="c1"># Get all aliases with max frequency</span>
    <span class="n">most_frequent</span> <span class="o">=</span> <span class="p">[</span><span class="n">alias</span> <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">alias_counter</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
                    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="n">max_count</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">most_frequent</span>

<span class="c1"># Get unique emotions (excluding &quot;not offensive&quot;)</span>
<span class="n">emotions</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;emotion&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;not offensive&quot;</span><span class="p">][</span><span class="s1">&#39;emotion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="c1"># Create figure with 5x2 subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Store dominance results</span>
<span class="n">dominance_results</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">comm_id</span><span class="p">,</span> <span class="n">comm_row</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">communities_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">idx</span><span class="o">%</span><span class="k">2</span>]
    <span class="n">members</span> <span class="o">=</span> <span class="n">comm_row</span><span class="p">[</span><span class="s1">&#39;all_members&#39;</span><span class="p">]</span>
    <span class="n">emotion_counts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;overall&#39;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> 
                     <span class="s1">&#39;male&#39;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> 
                     <span class="s1">&#39;female&#39;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)}</span>
    <span class="n">total</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;overall&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;male&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="n">names_df</span><span class="p">[</span><span class="s1">&#39;canonical_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">member</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">gender</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span>
        <span class="n">article_ids</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;article_ids&#39;</span><span class="p">]</span>
        <span class="n">aliases</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;aliases&#39;</span><span class="p">]</span>
        
        <span class="c1"># Eval string-encoded lists with error handling</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">article_ids</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">article_ids</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">article_ids</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> 
                <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aliases</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">aliases</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">aliases</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">aliases</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Filter articles using improved function</span>
        <span class="n">df_e</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;article_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">article_ids</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_e</span> <span class="o">=</span> <span class="n">df_e</span><span class="p">[</span><span class="n">df_e</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">article_about_member</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">aliases</span><span class="p">)),</span> 
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)]</span>
        <span class="n">df_e</span> <span class="o">=</span> <span class="n">df_e</span><span class="p">[</span><span class="n">df_e</span><span class="p">[</span><span class="s1">&#39;emotion&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;not offensive&quot;</span><span class="p">]</span>
        
        <span class="c1"># Count emotions</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_e</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">emotion</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;emotion&#39;</span><span class="p">]</span>
            <span class="n">emotion_counts</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">][</span><span class="n">emotion</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">total</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="k">if</span> <span class="n">gender</span> <span class="o">==</span> <span class="s1">&#39;male&#39;</span><span class="p">:</span>
                <span class="n">emotion_counts</span><span class="p">[</span><span class="s1">&#39;male&#39;</span><span class="p">][</span><span class="n">emotion</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">total</span><span class="p">[</span><span class="s1">&#39;male&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">gender</span> <span class="o">==</span> <span class="s1">&#39;female&#39;</span><span class="p">:</span>
                <span class="n">emotion_counts</span><span class="p">[</span><span class="s1">&#39;female&#39;</span><span class="p">][</span><span class="n">emotion</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">total</span><span class="p">[</span><span class="s1">&#39;female&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Calculate proportions with safety checks</span>
    <span class="n">proportions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dominance</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">,</span> <span class="s1">&#39;male&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">]:</span>
        <span class="n">proportions</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">emotions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">total</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">prop</span> <span class="o">=</span> <span class="n">emotion_counts</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">e</span><span class="p">]</span> <span class="o">/</span> <span class="n">total</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">proportions</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">proportions</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Determine emotion dominance</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">emotion</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">emotions</span><span class="p">):</span>
        <span class="n">male_prop</span> <span class="o">=</span> <span class="n">proportions</span><span class="p">[</span><span class="s1">&#39;male&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">female_prop</span> <span class="o">=</span> <span class="n">proportions</span><span class="p">[</span><span class="s1">&#39;female&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">male_prop</span> <span class="o">+</span> <span class="n">female_prop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dominance</span><span class="p">[</span><span class="n">emotion</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ratio_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">male_prop</span> <span class="o">-</span> <span class="n">female_prop</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ratio_diff</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
                <span class="n">dominance</span><span class="p">[</span><span class="n">emotion</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;tie&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dominance</span><span class="p">[</span><span class="n">emotion</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;male&#39;</span> <span class="k">if</span> <span class="n">male_prop</span> <span class="o">&gt;</span> <span class="n">female_prop</span> <span class="k">else</span> <span class="s1">&#39;female&#39;</span>
    
    <span class="n">dominance_results</span><span class="p">[</span><span class="n">comm_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">dominance</span>

    <span class="c1"># Enhanced visualization</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">emotions</span><span class="p">))</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mf">0.28</span>  <span class="c1"># Adjusted for better spacing</span>
    
    <span class="n">bars</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="p">,</span> <span class="n">proportions</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
              <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Overall&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">),</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">proportions</span><span class="p">[</span><span class="s1">&#39;male&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
              <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Male&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">),</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="p">,</span> <span class="n">proportions</span><span class="p">[</span><span class="s1">&#39;female&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> 
              <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Female&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="p">]</span>
    
    <span class="c1"># Dynamic dominance markers</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">emotion</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">emotions</span><span class="p">):</span>
        <span class="n">y_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.07</span>  <span class="c1"># Lower position</span>
        <span class="n">dom</span> <span class="o">=</span> <span class="n">dominance</span><span class="p">[</span><span class="n">emotion</span><span class="p">]</span>
        <span class="n">marker_props</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ha&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
            <span class="s1">&#39;fontweight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;rotation&#39;</span><span class="p">:</span> <span class="mi">45</span> <span class="k">if</span> <span class="n">dom</span> <span class="o">==</span> <span class="s1">&#39;tie&#39;</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="n">dom</span> <span class="o">==</span> <span class="s1">&#39;male&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_pos</span><span class="p">,</span> <span class="s1">&#39;♂&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">marker_props</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dom</span> <span class="o">==</span> <span class="s1">&#39;female&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_pos</span><span class="p">,</span> <span class="s1">&#39;♀&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">marker_props</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dom</span> <span class="o">==</span> <span class="s1">&#39;tie&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_pos</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">marker_props</span><span class="p">)</span>

    <span class="c1"># Formatting</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">emotions</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Emotion Category&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Normalized Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Community </span><span class="si">{</span><span class="n">comm_id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1"> Emotion Analysis</span><span class="se">\n</span><span class="s1">(NER-Validated Content)&#39;</span><span class="p">,</span> 
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_axisbelow</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Handle empty subplots</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">communities_df</span><span class="p">),</span> <span class="mi">10</span><span class="p">):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">idx</span><span class="o">%</span><span class="k">2</span>].axis(&#39;off&#39;)

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;emotion-analysis.pdf&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/34ccbeaaf8f24b3b4cd94d9657fca230c2442769bf9d630bcbfc6d704b81a98c.png" src="_images/34ccbeaaf8f24b3b4cd94d9657fca230c2442769bf9d630bcbfc6d704b81a98c.png" />
</div>
</div>
</section>
</section>
<section id="random-sampled-analysis">
<h3><strong>Random-sampled analysis</strong><a class="headerlink" href="#random-sampled-analysis" title="Link to this heading">#</a></h3>
<section id="general-td-idf">
<h4>General TD-IDF<a class="headerlink" href="#general-td-idf" title="Link to this heading">#</a></h4>
<p>First we check the overall language differnces between all women and men.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sample 500 men and 500 women with seed 2</span>
<span class="n">men_sample</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="n">names_df</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;male&#39;</span><span class="p">]</span>
<span class="n">women_sample</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="n">names_df</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;female&#39;</span><span class="p">]</span>

<span class="c1"># Combine the samples</span>
<span class="n">sampled_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">men_sample</span><span class="p">,</span> <span class="n">women_sample</span><span class="p">])</span>

<span class="c1"># Print the sampled DataFrame</span>
<span class="n">sampled_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;num_articles&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Assume sampled_df is already defined with &#39;canonical_name&#39; and &#39;person_descriptions&#39;</span>

<span class="c1"># Helper to clean and combine descriptions</span>
<span class="k">def</span><span class="w"> </span><span class="nf">preprocess_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^\wæøåÆØÅ-]&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">w</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()])</span>

<span class="c1"># Build text per person</span>
<span class="n">sampled_df</span><span class="p">[</span><span class="s1">&#39;clean_text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampled_df</span><span class="p">[</span><span class="s1">&#39;person_descriptions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">preprocess_text</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="p">[])))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
<span class="p">)</span>

<span class="c1"># Split by gender</span>
<span class="n">men_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sampled_df</span><span class="p">[</span><span class="n">sampled_df</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;male&#39;</span><span class="p">][</span><span class="s1">&#39;clean_text&#39;</span><span class="p">])</span>
<span class="n">women_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sampled_df</span><span class="p">[</span><span class="n">sampled_df</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;female&#39;</span><span class="p">][</span><span class="s1">&#39;clean_text&#39;</span><span class="p">])</span>

<span class="c1"># Token lists</span>
<span class="n">men_tokens</span> <span class="o">=</span> <span class="n">men_text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="n">women_tokens</span> <span class="o">=</span> <span class="n">women_text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="c1"># Frequency counters</span>
<span class="n">men_freq</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">men_tokens</span><span class="p">)</span>
<span class="n">women_freq</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">women_tokens</span><span class="p">)</span>

<span class="c1"># Unique words (appear only in that gender)</span>
<span class="n">all_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">men_tokens</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">women_tokens</span><span class="p">)</span>
<span class="n">word_occ</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
<span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">men_tokens</span><span class="p">:</span>
    <span class="n">word_occ</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;male&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">women_tokens</span><span class="p">:</span>
    <span class="n">word_occ</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;female&#39;</span><span class="p">)</span>

<span class="n">men_unique</span> <span class="o">=</span> <span class="p">{</span><span class="n">w</span><span class="p">:</span> <span class="n">men_freq</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">men_freq</span> <span class="k">if</span> <span class="n">word_occ</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;male&#39;</span><span class="p">}}</span>
<span class="n">women_unique</span> <span class="o">=</span> <span class="p">{</span><span class="n">w</span><span class="p">:</span> <span class="n">women_freq</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">women_freq</span> <span class="k">if</span> <span class="n">word_occ</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;female&#39;</span><span class="p">}}</span>

<span class="c1"># TF-IDF</span>
<span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">token_pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\b[^\d\W]{3,}\b&#39;</span><span class="p">,</span> <span class="n">min_df</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="n">ngram_range</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">tfidf</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">([</span><span class="n">men_text</span><span class="p">,</span> <span class="n">women_text</span><span class="p">])</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
<span class="n">terms</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">men_tfidf</span> <span class="o">=</span> <span class="p">{</span><span class="n">terms</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">tfidf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tfidf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="mi">100</span><span class="p">]</span> <span class="k">if</span> <span class="n">tfidf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">}</span>
<span class="n">women_tfidf</span> <span class="o">=</span> <span class="p">{</span><span class="n">terms</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">tfidf</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tfidf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="mi">100</span><span class="p">]</span> <span class="k">if</span> <span class="n">tfidf</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">}</span>


<span class="c1"># Take top N</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">men_tfidf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">men_tfidf</span><span class="o">.</span><span class="n">items</span><span class="p">())[:</span><span class="n">N</span><span class="p">])</span>
<span class="n">women_tfidf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">women_tfidf</span><span class="o">.</span><span class="n">items</span><span class="p">())[:</span><span class="n">N</span><span class="p">])</span>
<span class="n">men_freq_top</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">men_freq</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
<span class="n">women_freq_top</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">women_freq</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
<span class="n">men_unique_top</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">men_unique</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="n">N</span><span class="p">])</span>
<span class="n">women_unique_top</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">women_unique</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="n">N</span><span class="p">])</span>


<span class="c1">#REMOVE DUPLICATES:</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">difflib</span><span class="w"> </span><span class="kn">import</span> <span class="n">SequenceMatcher</span>

<span class="k">def</span><span class="w"> </span><span class="nf">remove_similar_words</span><span class="p">(</span><span class="n">word_dict</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.85</span><span class="p">):</span>
    <span class="n">unique_words</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">word_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">SequenceMatcher</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">threshold</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">unique_words</span><span class="p">):</span>
            <span class="n">unique_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="n">filtered</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>
    <span class="k">return</span> <span class="n">filtered</span>

<span class="c1"># Apply before plotting</span>
<span class="n">men_tfidf</span> <span class="o">=</span> <span class="n">remove_similar_words</span><span class="p">(</span><span class="n">men_tfidf</span><span class="p">)</span>
<span class="n">women_tfidf</span> <span class="o">=</span> <span class="n">remove_similar_words</span><span class="p">(</span><span class="n">women_tfidf</span><span class="p">)</span>

<span class="n">men_freq_top</span> <span class="o">=</span> <span class="n">remove_similar_words</span><span class="p">(</span><span class="n">men_freq_top</span><span class="p">)</span>
<span class="n">women_freq_top</span> <span class="o">=</span> <span class="n">remove_similar_words</span><span class="p">(</span><span class="n">women_freq_top</span><span class="p">)</span>

<span class="n">men_unique_top</span> <span class="o">=</span> <span class="n">remove_similar_words</span><span class="p">(</span><span class="n">men_unique_top</span><span class="p">)</span>
<span class="n">women_unique_top</span> <span class="o">=</span> <span class="n">remove_similar_words</span><span class="p">(</span><span class="n">women_unique_top</span><span class="p">)</span>


<span class="c1"># Plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">plot_sets</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">men_tfidf</span><span class="p">,</span>  <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Blues&quot;</span><span class="p">,</span> <span class="s2">&quot;Men TF-IDF&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="n">men_freq_top</span><span class="p">,</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;Blues&quot;</span><span class="p">,</span> <span class="s2">&quot;Men Frequency&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="n">men_unique_top</span><span class="p">,</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;Blues&quot;</span><span class="p">,</span> <span class="s2">&quot;Men Unique&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="n">women_tfidf</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Reds&quot;</span><span class="p">,</span>  <span class="s2">&quot;Women TF-IDF&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="n">women_freq_top</span><span class="p">,</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;Reds&quot;</span><span class="p">,</span> <span class="s2">&quot;Women Frequency&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="n">women_unique_top</span><span class="p">,</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="s2">&quot;Reds&quot;</span><span class="p">,</span> <span class="s2">&quot;Women Unique&quot;</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">word_dict</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">plot_sets</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">word_dict</span><span class="p">:</span>
        <span class="n">wc</span> <span class="o">=</span> <span class="n">WordCloud</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">background_color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">wc</span><span class="o">.</span><span class="n">generate_from_frequencies</span><span class="p">(</span><span class="n">word_dict</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;No Data&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;random-sample-wordcloud.pdf&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e064d3b0ec278604321ea1d3d2a8544b5f630ad7870d2de36708d4e738881d09.png" src="_images/e064d3b0ec278604321ea1d3d2a8544b5f630ad7870d2de36708d4e738881d09.png" />
</div>
</div>
</section>
<section id="p-test-of-offensive-langauge">
<h4>P-test of offensive langauge<a class="headerlink" href="#p-test-of-offensive-langauge" title="Link to this heading">#</a></h4>
<p>We see that there is indeed a tendency for NSFW langauge against women, is it something thats significant?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">ttest_1samp</span>
<span class="c1"># Number of trials and sample size</span>
<span class="n">n_trials</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">n_per_gender</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># Storage for per-trial averages</span>
<span class="n">avg_male_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">avg_female_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">diff_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">#Problem implemnting the previous article_About_member, so we use greedy assumption that if they are mentioned atleast 3 times, the article will be relevant. </span>
<span class="k">def</span><span class="w"> </span><span class="nf">article_about_member</span><span class="p">(</span><span class="n">article_row</span><span class="p">,</span> <span class="n">aliases</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if article is about member using NER clusters.&quot;&quot;&quot;</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">article_row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ner_clusters&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">clusters</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">alias_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">clusters</span> <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">alias_count</span> <span class="o">&gt;=</span> <span class="mi">3</span>

<span class="k">def</span><span class="w"> </span><span class="nf">compute_avg_sentiment</span><span class="p">(</span><span class="n">sampled_df</span><span class="p">,</span> <span class="n">articles_df</span><span class="p">):</span>
    <span class="n">male_sents</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">female_sents</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">sampled_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">gender</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span>
        <span class="n">aliases</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="s1">&#39;aliases&#39;</span><span class="p">]</span>
        <span class="n">art_ids</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="s1">&#39;article_ids&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aliases</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">aliases</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">aliases</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> 
                <span class="n">aliases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">art_ids</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">art_ids</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">art_ids</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> 
                <span class="k">continue</span>
        
        <span class="n">df_hate</span> <span class="o">=</span> <span class="n">articles_df</span><span class="p">[</span><span class="n">articles_df</span><span class="p">[</span><span class="s1">&#39;article_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">art_ids</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_hate</span> <span class="o">=</span> <span class="n">df_hate</span><span class="p">[</span><span class="n">df_hate</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">article_about_member</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">aliases</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">df_hate</span><span class="p">[</span><span class="s1">&#39;sentiment_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_hate</span><span class="p">[</span><span class="s1">&#39;hate_speech&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">({</span>
            <span class="s1">&#39;not offensive&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> 
            <span class="s1">&#39;spam &amp; indhold&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;personangreb&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;sprogbrug&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">})</span>
        
        <span class="n">scores</span> <span class="o">=</span> <span class="n">df_hate</span><span class="p">[</span><span class="s1">&#39;sentiment_num&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gender</span> <span class="o">==</span> <span class="s1">&#39;male&#39;</span><span class="p">:</span>
            <span class="n">male_sents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">gender</span> <span class="o">==</span> <span class="s1">&#39;female&#39;</span><span class="p">:</span>
            <span class="n">female_sents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
    
    <span class="n">avg_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">male_sents</span><span class="p">)</span> <span class="k">if</span> <span class="n">male_sents</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">avg_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">female_sents</span><span class="p">)</span> <span class="k">if</span> <span class="n">female_sents</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">avg_m</span><span class="p">,</span> <span class="n">avg_f</span>

<span class="c1"># Main trial loop</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">):</span>
    <span class="n">men_sample</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="n">names_df</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;male&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_per_gender</span><span class="p">)</span>
    <span class="n">women_sample</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="n">names_df</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;female&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_per_gender</span><span class="p">)</span>
    <span class="n">sampled_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">men_sample</span><span class="p">,</span> <span class="n">women_sample</span><span class="p">])</span>  <span class="c1"># Use pd.concat instead of np.concatenate</span>
    
    <span class="n">avg_m</span><span class="p">,</span> <span class="n">avg_f</span> <span class="o">=</span> <span class="n">compute_avg_sentiment</span><span class="p">(</span><span class="n">sampled_df</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">avg_m</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">avg_f</span><span class="p">):</span>  <span class="c1"># Only append if both values are valid</span>
        <span class="n">avg_male_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_m</span><span class="p">)</span>
        <span class="n">avg_female_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_f</span><span class="p">)</span>
        <span class="n">diff_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_f</span> <span class="o">-</span> <span class="n">avg_m</span><span class="p">)</span>

<span class="c1"># One-sample t-test on the differences (H0: mean diff = 0)</span>
<span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">ttest_1samp</span><span class="p">(</span><span class="n">diff_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Plot the distribution of differences</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">diff_list</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_list</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> 
           <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Mean difference = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_list</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribution of Female-Male Sentiment Differences</span><span class="se">\n</span><span class="s2">(</span><span class="si">{</span><span class="n">n_trials</span><span class="si">}</span><span class="s2"> trials of </span><span class="si">{</span><span class="n">n_per_gender</span><span class="si">}</span><span class="s2"> samples each)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Difference in Mean Sentiment (Female - Male)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;sentiment-dist-gender.pdf&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Print results</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average male sentiment across trials: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">avg_male_list</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average female sentiment across trials: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">avg_female_list</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">T-test results (H0: no difference between genders):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  t-statistic = </span><span class="si">{</span><span class="n">t_stat</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  p-value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean difference = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_list</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (Female - Male)&quot;</span><span class="p">)</span>

<span class="c1"># Calculate 95% confidence interval</span>
<span class="n">ci_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">diff_list</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
<span class="n">ci_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">diff_list</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  95% Confidence Interval: [</span><span class="si">{</span><span class="n">ci_low</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">ci_high</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/942aa9a169b5ba59c3b21b0c6af9df4a0b2809c249219940558ddf509833bf75.png" src="_images/942aa9a169b5ba59c3b21b0c6af9df4a0b2809c249219940558ddf509833bf75.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results:
Average male sentiment across trials: 0.943
Average female sentiment across trials: 0.924

T-test results (H0: no difference between genders):
  t-statistic = -14.544
  p-value = 0.0000
  Mean difference = -0.019 (Female - Male)
  95% Confidence Interval: [-0.060, 0.025]
</pre></div>
</div>
</div>
</div>
<p>We can with signifiacne reject the null hypthethis, and confirm the alternative hypothas, that there is indeed differnece between the genders and offensive langauge.</p>
<ul class="simple">
<li><p>Men’s sampled articles are, on average, 94.3% “not offensive.”</p></li>
<li><p>Women’s sampled articles are, on average, 92.1% “not offensive.”</p></li>
</ul>
<p>However 2 percent is not that much, it is because its hard to actually generalise offensive langauge using a NLP:</p>
<p>See for example this. This sentence clearly has NSFW langauge around a women. But its not targeted as “offensive”</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define keywords of interest</span>
<span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;patter&quot;</span><span class="p">]</span>
<span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span>

<span class="c1"># Filter articles that are not offensive and contain one of the keywords in the body</span>
<span class="n">filtered_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;hate_speech&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;not offensive&quot;</span><span class="p">)</span> <span class="o">&amp;</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="p">]</span>

<span class="c1"># Look for person descriptions that include any of the keywords</span>
<span class="n">matching_rows</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">person_descs</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;person_descriptions&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">person_descs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">person_descs</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">person_descs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">person_descs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">person</span><span class="p">,</span> <span class="n">desc_list</span> <span class="ow">in</span> <span class="n">person_descs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">kw</span> <span class="ow">in</span> <span class="n">desc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">)</span> <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">desc_list</span><span class="p">):</span>
                <span class="n">matching_rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>

                    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;person&quot;</span><span class="p">:</span> <span class="n">person</span><span class="p">,</span>
                    <span class="s2">&quot;descriptions&quot;</span><span class="p">:</span> <span class="n">desc_list</span><span class="p">,</span>

                <span class="p">})</span>

<span class="n">matching_rows</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Return first match only for brevity</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;title&#39;: &#39;Victoria Beckham: Gode bryster&#39;,
  &#39;person&#39;: &#39;Victoria Beckham&#39;,
  &#39;descriptions&#39;: [&#39;popstjerne&#39;, &#39;plastikpatter&#39;]}]
</pre></div>
</div>
</div>
</div>
<p>In english:</p>
<p>Title: Victoria Beckham: Good breats</p>
<p>Descriptions: [‘Popstar’, ‘Plasticboobs’]</p>
</section>
<section id="p-test-of-sentiment">
<h4>P-test of sentiment<a class="headerlink" href="#p-test-of-sentiment" title="Link to this heading">#</a></h4>
<p>We also saw on previous plots that men typiccaly are in articles with less positive sentiment, is that also a general thing?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Number of trials and sample size</span>
<span class="n">n_trials</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">n_per_gender</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># Storage for per-trial averages</span>
<span class="n">avg_male_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">avg_female_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">diff_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">article_about_member</span><span class="p">(</span><span class="n">article_row</span><span class="p">,</span> <span class="n">aliases</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if article is about member using NER clusters.&quot;&quot;&quot;</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">article_row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ner_clusters&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">clusters</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">alias_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">clusters</span> <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">alias_count</span> <span class="o">&gt;=</span> <span class="mi">3</span>

<span class="k">def</span><span class="w"> </span><span class="nf">compute_avg_sentiment</span><span class="p">(</span><span class="n">sampled_df</span><span class="p">,</span> <span class="n">articles_df</span><span class="p">):</span>
    <span class="n">male_sents</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">female_sents</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">sampled_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">gender</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span>
        <span class="n">aliases</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="s1">&#39;aliases&#39;</span><span class="p">]</span>
        <span class="n">art_ids</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="s1">&#39;article_ids&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aliases</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">aliases</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">aliases</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> 
                <span class="n">aliases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">art_ids</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">art_ids</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">art_ids</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> 
                <span class="k">continue</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">articles_df</span><span class="p">[</span><span class="n">articles_df</span><span class="p">[</span><span class="s1">&#39;article_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">art_ids</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">article_about_member</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">aliases</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sentiment_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sentiment_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">({</span>
            <span class="s1">&#39;positive&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> 
            <span class="s1">&#39;negative&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">})</span>
        
        <span class="n">scores</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sentiment_num&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gender</span> <span class="o">==</span> <span class="s1">&#39;male&#39;</span><span class="p">:</span>
            <span class="n">male_sents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">gender</span> <span class="o">==</span> <span class="s1">&#39;female&#39;</span><span class="p">:</span>
            <span class="n">female_sents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
    
    <span class="n">avg_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">male_sents</span><span class="p">)</span> <span class="k">if</span> <span class="n">male_sents</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">avg_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">female_sents</span><span class="p">)</span> <span class="k">if</span> <span class="n">female_sents</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">avg_m</span><span class="p">,</span> <span class="n">avg_f</span>

<span class="c1"># Main trial loop</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">):</span>
    <span class="n">men_sample</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="n">names_df</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;male&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_per_gender</span><span class="p">)</span>
    <span class="n">women_sample</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="n">names_df</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;female&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_per_gender</span><span class="p">)</span>
    <span class="n">sampled_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">men_sample</span><span class="p">,</span> <span class="n">women_sample</span><span class="p">])</span>  <span class="c1"># Use pd.concat instead of np.concatenate</span>
    
    <span class="n">avg_m</span><span class="p">,</span> <span class="n">avg_f</span> <span class="o">=</span> <span class="n">compute_avg_sentiment</span><span class="p">(</span><span class="n">sampled_df</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">avg_m</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">avg_f</span><span class="p">):</span>  <span class="c1"># Only append if both values are valid</span>
        <span class="n">avg_male_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_m</span><span class="p">)</span>
        <span class="n">avg_female_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_f</span><span class="p">)</span>
        <span class="n">diff_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_f</span> <span class="o">-</span> <span class="n">avg_m</span><span class="p">)</span>

<span class="c1"># One-sample t-test on the differences (H0: mean diff = 0)</span>
<span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">ttest_1samp</span><span class="p">(</span><span class="n">diff_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Plot the distribution of differences</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">diff_list</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_list</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> 
           <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Mean difference = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_list</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribution of Female-Male Sentiment Differences</span><span class="se">\n</span><span class="s2">(</span><span class="si">{</span><span class="n">n_trials</span><span class="si">}</span><span class="s2"> trials of </span><span class="si">{</span><span class="n">n_per_gender</span><span class="si">}</span><span class="s2"> samples each)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Difference in Mean Sentiment (Female - Male)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;sentiment-ment-dist.pdf&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Print results</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average male sentiment across trials: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">avg_male_list</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average female sentiment across trials: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">avg_female_list</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">T-test results (H0: no difference between genders):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  t-statistic = </span><span class="si">{</span><span class="n">t_stat</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  p-value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean difference = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_list</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (Female - Male)&quot;</span><span class="p">)</span>

<span class="c1"># Calculate 95% confidence interval</span>
<span class="n">ci_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">diff_list</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
<span class="n">ci_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">diff_list</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  95% Confidence Interval: [</span><span class="si">{</span><span class="n">ci_low</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">ci_high</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/368eedef980b68a38305f8aa76c1f1c4d0aba36022bad2d5c9f153d02d73363a.png" src="_images/368eedef980b68a38305f8aa76c1f1c4d0aba36022bad2d5c9f153d02d73363a.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Results:
Average male sentiment across trials: 0.527
Average female sentiment across trials: 0.594

T-test results (H0: no difference between genders):
  t-statistic = 22.083
  p-value = 0.0000
  Mean difference = 0.067 (Female - Male)
  95% Confidence Interval: [-0.034, 0.159]
</pre></div>
</div>
</div>
</div>
<p>We can with significance reject the null hypothethis, and confirm the alternative hypothas, that there is indeed differnece between the genders and sentiment value.</p>
<hr class="docutils" />
<p><strong>Discussion</strong></p>
<p>Our analysis revealed some tendecy towards gender-specific language patterns, particularly through the TF-IDF metrics. Among these the TF-Unique metrics proved most effective in highlighting differences between how men and women are described. This was especially evident in the use of sexualized or appearance-focused language in the womens part of the wordcloud. In contrast, standard TF-IDF and TF measures were less effective in capturing such nuances and were better at describing common words for the community.</p>
<p>However, other NLP-based features such as sentiment analysis, emotion detection, and hate speech classification were less consistent in identifying strong or systematic gender bias. While we did observe statistically significant differences (for example women were associated with slightly more positive sentiment and slightly higher levels of offensive language), the magnitude of these effects was relatively small, typically under 5 percent. and while the statistical test using random sampling did show signifacnt difference its hard to conclude anything given the current NLP methods.</p>
<p>It is also important to recognize the limitations of relying primarily on TF-IDF for conclusions about bias. These metrics reflect surface-level word frequency rather than context or intent. A more robust approach, such as training machine learning models specifically to detect biased framing or implicit stereotypes, could give deeper insights. However, due to licensing restrictions on the EB-NeRD dataset (which prohibits training models on the text), developing such a model would require access to a different dataset.</p>
<hr class="docutils" />
<p><strong>Conclusion</strong> There is indeed a tendency towards gender-specific langauge. Some is trivial such as “dad”, “mom” and other titltes typicaly associated with gender. However our analysis also showed that women were more prone to NSFW words, but are spoken more positive about in terms of sentiment. Whereas men are typiccaly in articles with more negative sentiment. The distribution of emotions of articles seems to be equally distributed between the genders.</p>
<hr class="docutils" />
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="analysis.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Language Analysis</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-and-motivation">💡 Introduction and Motivation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset">🗂️ Dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pre-processing-and-overview">📶 Pre-Processing and Overview</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#subset-entertainment">Subset Entertainment</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#natural-language-processing-nlp">🌐 Natural Language Processing (NLP)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#named-entity-recognition-ner">Named Entity Recognition (NER)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dependency-parsing">Dependency Parsing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#coreference-resolution">Coreference Resolution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sentiment-analysis">Sentiment Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nlp-dataset">NLP Dataset</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#person-name-processing">🪪 Person Name Processing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#alias-assignment">Alias Assignment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#genderization">Genderization</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#network">👨‍👩‍👧‍👦 Network</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creation-of-co-mention-network">Creation of co-mention network</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-of-co-mention-graph">Analysis of co-mention graph</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#powerlaw-and-top-hubs">Powerlaw and top-hubs:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#random-network-or-tendency">Random network or tendency?:</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#community-detection">Community detection</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#language-analysis-using-nlp-and-tf-idf">🔎 Language Analysis (Using NLP and TF-IDF)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#community-analysis">Community Analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#gendered-wording-analysis-using-tf-idf">Gendered wording analysis using TF-IDF</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sentiment-analysis-of-communtiies">Sentiment analysis of communtiies</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hatespeech-analysis-of-communtiies">Hatespeech analysis of communtiies</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#emotion-distribution-of-communtiies">Emotion distribution of communtiies</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-sampled-analysis"><strong>Random-sampled analysis</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#general-td-idf">General TD-IDF</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#p-test-of-offensive-langauge">P-test of offensive langauge</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#p-test-of-sentiment">P-test of sentiment</a></li>
</ul>
</li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>